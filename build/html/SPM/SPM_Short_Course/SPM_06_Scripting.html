<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SPM Tutorial #6: Scripting &mdash; Andy&#39;s Brain Book 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b76e3c8a" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="SPM Tutorial #7: Setting the Origin" href="SPM_07_SettingTheOrigin.html" />
    <link rel="prev" title="Chapter 6: Running the First-Level Analysis" href="SPM_Statistics/SPM_06_Stats_Running_1stLevel_Analysis.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Andy's Brain Book
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Install</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation/fsl_mac_install.html">Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Unix for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_Intro.html">What is Unix?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_01_Navigation.html">Unix Tutorial #1: 目录操作 (Directories and Navigation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_02_CopyRemove.html">Unix Tutorial #2: Copying and Removing Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_03_ReadingTextFiles.html">Unix Tutorial #3: Reading Text Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_04_ShellsVariables.html">Unix Tutorial #4: Shells and Path Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_05_ForLoops.html">Unix Tutorial #5: For-Loops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_06_IfElse.html">Unix Tutorial #6: Conditional Statements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_07_Scripting.html">Unix Tutorial #7: Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_08_Sed.html">Unix Tutorial #8: The Sed Command</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_09_AutomatingTheAnalysis.html">Unix Tutorial #9: Automating The Analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">fMRI Short Course with FSL</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_Intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_01_DataDownload.html">fMRI Tutorial #1: Downloading the Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_02_ExperimentalDesign.html">fMRI Tutorial #2: Overview of The Flanker Task</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_03_LookingAtTheData.html">fMRI Tutorial #3: Looking at the Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_04_Preprocessing.html">fMRI Tutorial #4: Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_05_1stLevelAnalysis.html">fMRI Tutorial #5: Statistics and Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_06_Scripting.html">fMRI Tutorial #6: Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_07_2ndLevelAnalysis.html">fMRI Tutorial #7: 2nd-Level Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_08_3rdLevelAnalysis.html">fMRI Tutorial #8: 3rd-Level Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_09_ROIAnalysis.html">fMRI Tutorial #9: ROI Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_10_Summary.html">fMRI Tutorial #10: Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_Appendices.html">fMRI Short Course: Appendices</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FreeSurfer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FreeSurfer/FreeSurfer_Introduction.html">FreeSurfer Short Course</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">E-Prime</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../E-Prime/E-Prime_Overview.html">Overview of E-Prime</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">AFNI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../AFNI/AFNI_Overview.html">AFNI Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SPM</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../SPM_Overview.html">SPM Overview</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../SPM_Overview.html#what-is-spm">What is SPM?</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="SPM_fMRI_Intro.html">Introduction to SPM</a></li>
<li class="toctree-l3"><a class="reference internal" href="SPM_01_DataDownload.html">SPM Tutorial #1: Downloading the Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="SPM_02_Flanker.html">SPM Tutorial #2: The Flanker Task</a></li>
<li class="toctree-l3"><a class="reference internal" href="SPM_03_LookingAtData.html">SPM Tutorial #3: Looking at the Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="SPM_04_Preprocessing.html">SPM Tutorial #4: Preprocessing</a></li>
<li class="toctree-l3"><a class="reference internal" href="SPM_05_1stLevelAnalysis.html">SPM Tutorial #5: Statistics and Modeling</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">SPM Tutorial #6: Scripting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-the-template">Creating the Template</a></li>
<li class="toctree-l4"><a class="reference internal" href="#editing-the-matlab-file">Editing the Matlab file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-the-script">Running the Script</a></li>
<li class="toctree-l4"><a class="reference internal" href="#next-steps">Next Steps</a></li>
<li class="toctree-l4"><a class="reference internal" href="#video">Video</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="SPM_07_SettingTheOrigin.html">SPM Tutorial #7: Setting the Origin</a></li>
<li class="toctree-l3"><a class="reference internal" href="SPM_08_GroupAnalysis.html">SPM Tutorial #8: Group Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="SPM_Intermezzo_Toolboxes.html">SPM Intermezzo: Toolboxes</a></li>
<li class="toctree-l3"><a class="reference internal" href="SPM_09_ROIAnalysis.html">SPM Tutorial #9: ROI Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="SummaryStatistics.html">Appendix A: Summary Statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="SPM_PPI.html">Appendix B: Psychophysiological Interactions (PPI) in SPM</a></li>
<li class="toctree-l3"><a class="reference internal" href="AppendixC_ParametricModulation.html">Appendix C: Parametric Modulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="AppendixD_DesignOptimization.html">Appendix D: DesignOptimization</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Functional Connectivity with the CONN Toolbox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FunctionalConnectivity/CONN_Overview.html">Functional Connectivity and the CONN Toolbox</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Parametric Modulation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../PM/PM_Overview.html">Parametric Modulation in SPM, FSL, and AFNI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Image Visualization with MRIcroGL</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../MRIcroGL/MRIcroGL_Overview.html">Image Visualization with MRIcroGL</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Introduction to the Human Connectome Project (HCP)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../HCP/HCP_Overview.html">Introduction to the Human Connectome Project</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Finite Impulse Response (FIR) Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FIR/FIR_Overview.html">Finite Impulse Response (FIR)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">fMRI Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Practicals/DesignOptimization.html">Design Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Diffusion Analysis with MRtrix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../MRtrix/MRtrix_Introduction.html">Introduction to MRtrix</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ASL Analysis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/ASL_Techniques.html">fASL Tutorial #1: Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/fASL_02_Download.html">fASL Tutorial #2: Downloading and Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/fASL_03_Task.html">fASL Tutorial #3: The N-Back Task</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/04_fASL_GUI.html">fASL Tutorial #4: The GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/05_fASL_Results.html">fASL Tutorial #5: Examining the Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/06_fASL_Quantification.html">fASL Tutorial #6: Quantification</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Frequently Asked Questions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FrequentlyAskedQuestions/FrequentlyAskedQuestions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Statistics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Statistics/GIMME.html">GIMME (Group Iterative Multiple Model Estimation)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Open Science</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../OpenScience/OS_Overview.html">Open Science</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Normalization Tools (ANTs)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ANTs/ANTs_Overview.html">Advanced Normalization Tools (ANTs)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tract-Based Spatial Statistics (TBSS)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../TBSS/TBSS_Overview.html">Introduction to Tract-Based Spatial Statistics (TBSS)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Statistics for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Stats/Stats_Overview.html">Statistics for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Machine Learning for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ML/ML_Overview.html">Machine Learning for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Slicer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Slicer/Slicer_Overview.html">Slicer Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CAT12</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CAT12/CAT12_Overview.html">Voxel-Based Morphometry with CAT12</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using the Supercomputer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Supercomputer/Supercomputer_Overview.html">Introduction to Supercomputing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Matlab for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Matlab/Matlab_Overview.html">Matlab for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ITK-Snap</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ITK-Snap/ITK-Snap_Overview.html">ITK-Snap_Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../PythonForNeuroimagers/PythonForNeuroimagers_Overview.html">Python for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Meta-Analysis for fMRI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../MetaAnalysis/MetaAnalysis_Overview.html">Meta-Analysis for Neuroimagers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Andy's Brain Book</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../SPM_Overview.html">SPM Overview</a></li>
      <li class="breadcrumb-item active">SPM Tutorial #6: Scripting</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/SPM/SPM_Short_Course/SPM_06_Scripting.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="spm-tutorial-6-scripting">
<span id="spm-06-scripting"></span><h1>SPM Tutorial #6: Scripting<a class="headerlink" href="#spm-tutorial-6-scripting" title="Link to this heading"></a></h1>
<hr class="docutils" />
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>After you’ve preprocessed and set up a model for a single run for a single subject, you will need to do the same steps for all of the runs for all of the subjects in your dataset. This may seem tedious but doable - we only have twenty-six subjects, and two runs per subject. You may think that it can be done over the course of a week or so; and you can always assign the task to a couple of Research Assistants.</p>
<p>This attitude is admirable, and if you take this approach you will be able to analyze all of the data eventually. But at some point you will run into two problems:</p>
<ol class="arabic simple">
<li><p>You will find that manually analyzing each run is not only tedious but prone to error, and the probability of making a mistake increases significantly as the number of runs to analyze also increases; and</p></li>
<li><p>For larger datasets - for example, eighty subjects with five runs each - this approach quickly becomes impractical.</p></li>
</ol>
<p>An alternative is to <strong>script</strong> your analysis. Just as an actor has a script which tells him what to say and where to stand and where to move, so can you write a script that tells your computer how to analyze your datasets. This has the double benefit of automating your analyses and being able to analyze datasets of any size - the code for analyzing two subjects or two hundred is virtually identical.</p>
<p>First we will create a template that contains the code needed to analyze a single run, and then we will use a <a class="reference internal" href="../../unix/Unix_05_ForLoops.html#unix-05-forloops"><span class="std std-ref">for-loop</span></a> to automate the analysis for all of the runs. The idea is simple; and although the code can be difficult to understand at first, once you become more comfortable with it you will see how you can apply it to any dataset.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The following tutorial complements the Unix tutorial on <a class="reference internal" href="../../unix/Unix_09_AutomatingTheAnalysis.html#unix-09-automatingtheanalysis"><span class="std std-ref">automating the analysis</span></a>. I recommend reading through that chapter if you need to review the Unix terms for scripting.</p>
</div>
</section>
<section id="creating-the-template">
<h2>Creating the Template<a class="headerlink" href="#creating-the-template" title="Link to this heading"></a></h2>
<p>When we analyzed the data for <code class="docutils literal notranslate"><span class="pre">sub-08</span></code>, clicking on each preprocessing button of the SPM GUI opened up a <strong>Batch Editor</strong> window. To create our script template, we will begin with the Batch Editor and add each of the preprocessing <strong>modules</strong> to our batch. We will then fill in the required inputs for each preprocessing and statistical modeling section, just like we did in the previous tutorials, and convert what we see in the GUI into Matlab code.</p>
<p>To begin, open up the SPM GUI and click on the <code class="docutils literal notranslate"><span class="pre">Batch</span></code> button. From the top of the Batch Editor window, click on the <code class="docutils literal notranslate"><span class="pre">SPM</span></code> menu and select the following modules in this order:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BasicIO</span> <span class="o">-&gt;</span> <span class="n">File</span><span class="o">/</span><span class="n">Dir</span> <span class="n">Operations</span> <span class="o">-&gt;</span> <span class="n">File</span> <span class="n">Operations</span> <span class="o">-&gt;</span> <span class="n">Named</span> <span class="n">File</span> <span class="n">Selector</span>
<span class="n">SPM</span> <span class="o">-&gt;</span> <span class="n">Spatial</span> <span class="o">-&gt;</span> <span class="n">Realign</span> <span class="o">-&gt;</span> <span class="n">Estimate</span> <span class="o">&amp;</span> <span class="n">Reslice</span>
<span class="n">SPM</span> <span class="o">-&gt;</span> <span class="n">Temporal</span> <span class="o">-&gt;</span> <span class="n">Slice</span> <span class="n">Timing</span>
<span class="n">SPM</span> <span class="o">-&gt;</span> <span class="n">Spatial</span> <span class="o">-&gt;</span> <span class="n">Coregister</span><span class="p">:</span> <span class="n">Estimate</span> <span class="o">&amp;</span> <span class="n">Reslice</span>
<span class="n">SPM</span> <span class="o">-&gt;</span> <span class="n">Spatial</span> <span class="o">-&gt;</span> <span class="n">Segment</span>
<span class="n">SPM</span> <span class="o">-&gt;</span> <span class="n">Spatial</span> <span class="o">-&gt;</span> <span class="n">Normalise</span> <span class="o">-&gt;</span> <span class="n">Write</span>
<span class="n">SPM</span> <span class="o">-&gt;</span> <span class="n">Spatial</span> <span class="o">-&gt;</span> <span class="n">Smooth</span>
<span class="n">BasicIO</span> <span class="o">-&gt;</span> <span class="n">File</span><span class="o">/</span><span class="n">Dir</span> <span class="n">Operations</span> <span class="o">-&gt;</span> <span class="n">File</span> <span class="n">Operations</span> <span class="o">-&gt;</span> <span class="n">File</span> <span class="n">Set</span> <span class="n">Split</span>
<span class="n">SPM</span> <span class="o">-&gt;</span> <span class="n">Stats</span> <span class="o">-&gt;</span> <span class="n">fMRI</span> <span class="n">Model</span> <span class="n">Specification</span>
<span class="n">SPM</span> <span class="o">-&gt;</span> <span class="n">Stats</span> <span class="o">-&gt;</span> <span class="n">Model</span> <span class="n">Estimation</span>
<span class="n">SPM</span> <span class="o">-&gt;</span> <span class="n">Stats</span> <span class="o">-&gt;</span> <span class="n">Contrast</span> <span class="n">Manager</span>
</pre></div>
</div>
<p>When you are done the “Module List” panel should look like this:</p>
<figure class="align-default">
<img alt="../../_images/06_ModuleList.png" src="../../_images/06_ModuleList.png" />
</figure>
<section id="file-selection-and-file-splitting">
<h3>File Selection and File Splitting<a class="headerlink" href="#file-selection-and-file-splitting" title="Link to this heading"></a></h3>
<p>You may have noticed two additional modules that don’t appear to have anything to do with analyzing the data directly. These are the <code class="docutils literal notranslate"><span class="pre">Named</span> <span class="pre">File</span> <span class="pre">Selector</span></code> and <code class="docutils literal notranslate"><span class="pre">File</span> <span class="pre">Set</span> <span class="pre">Split</span></code> modules.</p>
<p>The first one, <code class="docutils literal notranslate"><span class="pre">Named</span> <span class="pre">File</span> <span class="pre">Selector</span></code>, requires an input name and sets of files. We will create two file sets, and enter the <code class="docutils literal notranslate"><span class="pre">run-1_bold.nii</span></code> and <code class="docutils literal notranslate"><span class="pre">run-2_bold.nii</span></code> files for each set. When we come to the first preprocessing module, Realignment, we create two sessions and enter the respective files for each session.</p>
<figure class="align-default">
<img alt="../../_images/06_NamedFileSelector.png" src="../../_images/06_NamedFileSelector.png" />
</figure>
<p>The Smoothing module only accepts one session of images - in our example, the images that are output by the Normalisation module. Since the following preprocessing module, Model Specification, requires a separate set of files for each session, we can’t use the single file set from the Smoothing module as a <strong>dependency</strong> (explained in more detail below). The File Set Split module allows us to split the single set of output images from the Smoothing module into two separate sets, which we can then use as dependencies in the Model Specification module.</p>
<p>First, we label the File Set Name as <code class="docutils literal notranslate"><span class="pre">run1run2FileSplit</span></code> (this name is simply a label for reference in modules that come afterward). The Input File Set is the smoothed images from the Smoothing module, and as with the Named File Selector module, we create two Output File Sets. The Selection Index for the first one is <code class="docutils literal notranslate"><span class="pre">1</span></code>, and the Selection Index for the second one is <code class="docutils literal notranslate"><span class="pre">2</span></code>. This directs the module to split the smoothed images into two separate sets, based on how they were labeled by the previous Named File Selector module.</p>
<figure class="align-default">
<img alt="../../_images/06_FileSetSplit.png" src="../../_images/06_FileSetSplit.png" />
</figure>
</section>
<section id="filling-in-the-preprocessing-modules">
<h3>Filling in the Preprocessing Modules<a class="headerlink" href="#filling-in-the-preprocessing-modules" title="Link to this heading"></a></h3>
<p>You will now need to fill in each of the required fields, just like we did in the previous chapters. This will be the most tedious part of the tutorial, but remember: If you don’t script your analysis, you would have to do this manually for <em>every subject in your study</em>. The amount of time that would take, coupled with the fact that the odds of making a mistake increase with each subject you analyze by hand, should make this part seem worth the effort.</p>
<p>As you go along, at some point you may wonder what you are supposed to input for a later preprocessing step if the required data hasn’t been created yet. The Batch Editor allows you to use <strong>Dependencies</strong> from earlier steps, indicating that the input should come from the output of the previous step. For example, in the Realign module for the first Session if you click the <code class="docutils literal notranslate"><span class="pre">Dependency</span></code> button, you can select the option “Named File Selector: run1run2Files(1)”, and likewise for the second Session. It should look like this once you have filled it in:</p>
<figure class="align-default">
<img alt="../../_images/06_RealignDependency.png" src="../../_images/06_RealignDependency.png" />
</figure>
<p>And the same with the Slice Timing module:</p>
<figure class="align-default">
<img alt="../../_images/06_SliceTimingDependency.png" src="../../_images/06_SliceTimingDependency.png" />
</figure>
<p>Likewise, the Coregister step’s Reference Image can use the mean functional image generated during Realignment:</p>
<figure class="align-default">
<img alt="../../_images/06_CoregisterDependency.png" src="../../_images/06_CoregisterDependency.png" />
</figure>
<p>This is followed by Segmentation, which will use the same parameters that we specified <a class="reference internal" href="SPM_04_Preprocessing/04_SPM_Segmentation.html#spm-segmentation"><span class="std std-ref">earlier</span></a>:</p>
<figure class="align-default">
<img alt="../../_images/06_SegmentDependency.png" src="../../_images/06_SegmentDependency.png" />
</figure>
<p>The Normalise preprocessing step requires both the Forward Deformation fields from Segmentation, as well as both the Slice Timing outputs from Sessions 1 and 2 (which you can select by holding shift and clicking):</p>
<figure class="align-default">
<img alt="../../_images/06_NormaliseDependency.png" src="../../_images/06_NormaliseDependency.png" />
</figure>
<p>The Smooth module will use the images generated by Normalization:</p>
<figure class="align-default">
<img alt="../../_images/06_SmoothDependency.png" src="../../_images/06_SmoothDependency.png" />
</figure>
<p>And the Model Specification module will use the images created during Smoothing:</p>
<figure class="align-default">
<img alt="../../_images/06_ModelSpecificationDependency.png" src="../../_images/06_ModelSpecificationDependency.png" />
</figure>
<p>The Model Estimation module analyzes the data output from Model Specification:</p>
<figure class="align-default">
<img alt="../../_images/06_ModelEstimationDependency.png" src="../../_images/06_ModelEstimationDependency.png" />
</figure>
<p>And lastly, the contrast manager will load the SPM.mat file created by the Model Estimation module:</p>
<figure class="align-default">
<img alt="../../_images/06_ContrastDependency.png" src="../../_images/06_ContrastDependency.png" />
</figure>
<p>For the contrast module, we select the “Replicate&amp;Scale” option. This will replicate the contrast weights across all of the sessions for that subject, and scale them in inverse proportion to the number of sessions. In this example, since there are two sessions, each contrast weight will be scaled to 0.5 and -0.5, respectively.</p>
</section>
</section>
<section id="editing-the-matlab-file">
<h2>Editing the Matlab file<a class="headerlink" href="#editing-the-matlab-file" title="Link to this heading"></a></h2>
<p>The Batch module we have just created is specific to <code class="docutils literal notranslate"><span class="pre">sub-08</span></code>: We have used sub-08’s images and timing files, and the results will only apply to sub-08. If you clicked on the green Go button, it would run all of the preprocessing and model estimation steps in one go. With a few adjustments, however, we can adapt this module to all of the other subjects in our study.</p>
<p>First, we need to save the modules into a Matlab script. Click on <code class="docutils literal notranslate"><span class="pre">File</span> <span class="pre">-&gt;</span> <span class="pre">Save</span> <span class="pre">Batch</span> <span class="pre">and</span> <span class="pre">Script</span></code>, and label the file <code class="docutils literal notranslate"><span class="pre">RunPreproc_1stLevel</span></code>. Save it to the Flanker directory that contains all of your subjects. This will create a Matlab script file that you can open in the Matlab window.</p>
<p>From the Matlab terminal, navigate to the Flanker directory which contains the RunPreproc_1stLevel.m script, and type</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">open</span> <span class="n">RunPreproc_1stLevel_job</span><span class="o">.</span><span class="n">m</span>
</pre></div>
</div>
<p>To adapt this file so that it can analyze any subject, we will need to make the following edits:</p>
<ol class="arabic simple">
<li><p>Replace the number “08” with a variable containing a different subject number on each instance of a for-loop; and</p></li>
<li><p>Replace the username (in this case, “ajahn”) with a variable pointing to the username of whichever machine is currently being used.</p></li>
</ol>
<p>These two changes will allow us to place the existing code in a for-loop which will run over a set of numbers indicating each subject in the study.</p>
<p>At the beginning of the script, type the following code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="mi">01</span> <span class="mi">02</span><span class="p">];</span> <span class="o">%</span> <span class="n">Replace</span> <span class="k">with</span> <span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">subjects</span> <span class="n">you</span> <span class="n">wish</span> <span class="n">to</span> <span class="n">analyze</span>

<span class="n">user</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;USER&#39;</span><span class="p">);</span> <span class="o">%</span> <span class="n">Will</span> <span class="k">return</span> <span class="n">the</span> <span class="n">username</span> <span class="k">for</span> <span class="n">OSX</span> <span class="n">operating</span> <span class="n">systems</span>

<span class="k">for</span> <span class="n">subject</span><span class="o">=</span><span class="n">subjects</span>

<span class="n">subject</span> <span class="o">=</span> <span class="n">num2str</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="p">);</span>

<span class="k">if</span> <span class="n">isfile</span><span class="p">([</span><span class="s1">&#39;/Users/&#39;</span> <span class="n">user</span> <span class="s1">&#39;/Desktop/Flanker/sub-&#39;</span> <span class="n">subject</span> <span class="s1">&#39;/func/sub-&#39;</span> <span class="n">subject</span> <span class="s1">&#39;_task-flanker_run-1_bold.nii&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">display</span><span class="p">(</span><span class="s1">&#39;Run 1 has not been unzipped; unzipping now&#39;</span><span class="p">)</span>
    <span class="n">gunzip</span><span class="p">([</span><span class="s1">&#39;/Users/&#39;</span> <span class="n">user</span> <span class="s1">&#39;/Desktop/Flanker/sub-&#39;</span> <span class="n">subject</span> <span class="s1">&#39;/func/sub-&#39;</span> <span class="n">subject</span> <span class="s1">&#39;_task-flanker_run-1_bold.nii.gz&#39;</span><span class="p">])</span>
<span class="k">else</span>
    <span class="n">display</span><span class="p">(</span><span class="s1">&#39;Run 1 is already unzipped; doing nothing&#39;</span><span class="p">)</span>
<span class="n">end</span>

<span class="k">if</span> <span class="n">isfile</span><span class="p">([</span><span class="s1">&#39;/Users/&#39;</span> <span class="n">user</span> <span class="s1">&#39;/Desktop/Flanker/sub-&#39;</span> <span class="n">subject</span> <span class="s1">&#39;/func/sub-&#39;</span> <span class="n">subject</span> <span class="s1">&#39;_task-flanker_run-2_bold.nii&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">display</span><span class="p">(</span><span class="s1">&#39;Run 2 has not been unzipped; unzipping now&#39;</span><span class="p">)</span>
    <span class="n">gunzip</span><span class="p">([</span><span class="s1">&#39;/Users/&#39;</span> <span class="n">user</span> <span class="s1">&#39;/Desktop/Flanker/sub-&#39;</span> <span class="n">subject</span> <span class="s1">&#39;/func/sub-&#39;</span> <span class="n">subject</span> <span class="s1">&#39;_task-flanker_run-2_bold.nii.gz&#39;</span><span class="p">])</span>
<span class="k">else</span>
    <span class="n">display</span><span class="p">(</span><span class="s1">&#39;Run 2 is already unzipped; doing nothing&#39;</span><span class="p">)</span>
<span class="n">end</span>

<span class="k">if</span> <span class="n">isfile</span><span class="p">([</span><span class="s1">&#39;/Users/&#39;</span> <span class="n">user</span> <span class="s1">&#39;/Desktop/Flanker/sub-&#39;</span> <span class="n">subject</span> <span class="s1">&#39;/anat/sub-&#39;</span> <span class="n">subject</span> <span class="s1">&#39;_T1w.nii&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">display</span><span class="p">(</span><span class="s1">&#39;Anatomical image has not been unzipped; unzipping now&#39;</span><span class="p">)</span>
    <span class="n">gunzip</span><span class="p">([</span><span class="s1">&#39;/Users/&#39;</span> <span class="n">user</span> <span class="s1">&#39;/Desktop/Flanker/sub-&#39;</span> <span class="n">subject</span> <span class="s1">&#39;/anat/sub-&#39;</span> <span class="n">subject</span> <span class="s1">&#39;_T1w.nii.gz&#39;</span><span class="p">])</span>
<span class="k">else</span>
    <span class="n">display</span><span class="p">(</span><span class="s1">&#39;Anatomical image is already unzipped; doing nothing&#39;</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p>You should also type the word <code class="docutils literal notranslate"><span class="pre">end</span></code> at the last line of the script to indicate that all of the code that comes before is part of the for-loop.</p>
<p>The above code does the following:</p>
<ul class="simple">
<li><p>First, an <strong>array</strong> of numbers is created and stored in the variable <strong>subjects</strong>. The values are <code class="docutils literal notranslate"><span class="pre">01</span></code> and <code class="docutils literal notranslate"><span class="pre">02</span></code>; later on, we will expand this array to include all of the subject identification numbers in our experiment.</p></li>
<li><p>Next, the variable <code class="docutils literal notranslate"><span class="pre">user</span></code> takes the value returned from the command <code class="docutils literal notranslate"><span class="pre">getenv('USER')</span></code>. This should return the username of the current user of the computer - in the current example, “ajahn”.</p></li>
<li><p>We then begin a for-loop that is initialized with the code <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">subject=subjects</span></code>. This means that a new variable, “subject”, will assume the value of each consecutive entry in the array “subjects”. In other words, the first instance of the loop will assign the value “01” to <code class="docutils literal notranslate"><span class="pre">subject</span></code>; on the second instance, it will assign the value “02”, and so on, until the loop reaches the end of the array.</p></li>
<li><p>Since an array will strip any leading zeros, and since we need to convert the numbers in our array to a string, the “subject” variable is converted using the <code class="docutils literal notranslate"><span class="pre">num2str</span></code> command. The text <code class="docutils literal notranslate"><span class="pre">'%02d'</span></code> is <strong>string-formatting code</strong> indicating that the current value being converted from a number to a string should be <strong>zero-padded</strong> with as many zeros as needed until the number is two characters long. (Details about string formatting can be found <a class="reference external" href="https://www.mathworks.com/help/matlab/matlab_prog/formatting-strings.html">here</a>.)</p></li>
<li><p>The <a class="reference internal" href="../../unix/Unix_06_IfElse.html#unix-06-ifelse"><span class="std std-ref">conditional statements</span></a> look for whether the unzipped functional and anatomical files exist, and if they don’t, the files are unzipped using Matlab’s <code class="docutils literal notranslate"><span class="pre">gunzip</span></code> command.</p></li>
</ul>
<section id="concatenating-strings">
<h3>Concatenating strings<a class="headerlink" href="#concatenating-strings" title="Link to this heading"></a></h3>
<p>Throughout the rest of the code that was generated when we saved the Batch module as a Matlab script, we will need to replace each instance of <code class="docutils literal notranslate"><span class="pre">08</span></code> with the string <code class="docutils literal notranslate"><span class="pre">subject</span></code>, and each instance of <code class="docutils literal notranslate"><span class="pre">ajahn</span></code> (or whatever your username is) with the variable <code class="docutils literal notranslate"><span class="pre">user</span></code> that was defined above. This can be done using search and replace, but be careful that there aren’t other instances of the string “08” that aren’t attached to the string “sub-“.</p>
<p>In the example code above, we used brackets to <strong>horizontally concatenate</strong> strings with variables. A line of code like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;/Users/&#39;</span> <span class="n">user</span> <span class="s1">&#39;/Desktop/Flanker/sub-&#39;</span> <span class="n">subject</span> <span class="s1">&#39;/anat/sub-&#39;</span> <span class="n">subject</span> <span class="s1">&#39;_T1w.nii&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>will concatenate the strings surrounded by single apostrophes with the variables. If the variable “user” contains the value “ajahn” and the variable “subject” contains the value “08”, then the above code would expand to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;/Users/ajahn/Desktop/Flanker/sub-08/anat/sub-08_T1w.nii&#39;</span>
</pre></div>
</div>
<p>You will need to perform these substitutions for the rest of the script, taking care to use single apostrophes to set off the strings from the variables. Brackets will be required for this concatenation, even within the <strong>cells</strong> denoted by curly braces. (Cells are arrays that can contain several different data types, such as strings and numbers.)</p>
</section>
<section id="loading-the-onset-files">
<h3>Loading the Onset Files<a class="headerlink" href="#loading-the-onset-files" title="Link to this heading"></a></h3>
<p>The last part of the script we have to edit is the onset times. In this experiment, each subject had different onset times for each condition. If the timing files have already been converted to a different format, then you can create a variable that contains the timing information and insert it into the “onset” field for the stats module. For example, the following code found around line 107 of the Matlab script can be changed from this, which contains onset times specific to sub-08:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">matlabbatch</span><span class="p">{</span><span class="mi">9</span><span class="p">}</span><span class="o">.</span><span class="n">spm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">fmri_spec</span><span class="o">.</span><span class="n">sess</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">onset</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span>
                                                          <span class="mi">10</span>
                                                          <span class="mi">20</span>
                                                          <span class="mi">52</span>
                                                          <span class="mi">88</span>
                                                          <span class="mi">130</span>
                                                          <span class="mi">144</span>
                                                          <span class="mi">174</span>
                                                          <span class="mi">248</span>
                                                          <span class="mi">260</span>
                                                          <span class="mi">274</span><span class="p">];</span>
</pre></div>
</div>
<p>To this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data_incongruent_run1</span> <span class="o">=</span> <span class="n">load</span><span class="p">([</span><span class="s1">&#39;/Users/&#39;</span> <span class="n">user</span> <span class="s1">&#39;/Desktop/Flanker/sub-&#39;</span> <span class="n">subject</span> <span class="s1">&#39;/func/incongruent_run1.txt&#39;</span><span class="p">]);</span>

<span class="n">matlabbatch</span><span class="p">{</span><span class="mi">9</span><span class="p">}</span><span class="o">.</span><span class="n">spm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">fmri_spec</span><span class="o">.</span><span class="n">sess</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">onset</span> <span class="o">=</span> <span class="n">data_incongruent_run1</span><span class="p">(:,</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>In which the variable <code class="docutils literal notranslate"><span class="pre">data_incongruent_run1</span></code> stores the onset times for the subject in the current loop, and then enters those numbers into the onset field. Note that the code (:,1) indicates that only the first column of the variable should be read, which contains the onset times.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You will need to read the onset times for each session and each condition separately - i.e., you will need to create variables for the Incongruent and Congruent conditions for both run 1 and run 2.</p>
</div>
</section>
</section>
<section id="running-the-script">
<h2>Running the Script<a class="headerlink" href="#running-the-script" title="Link to this heading"></a></h2>
<p>When you have finished editing the script, save it and return to the Matlab terminal. You can then execute the script by typing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RunPreproc_1stLevel_job</span>
</pre></div>
</div>
<p>You will then see windows pop up as each preprocessing and statistical module is run, similar to what you would see if you executed each module manually through the GUI.</p>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading"></a></h2>
<p>The script should only take a few minutes to run for both sub-01 and sub-02. When you are finished, we will examine the output; and as you will see, there are still some issues that need to be resolved. To see what the problems are, and how to fix them, click the <code class="docutils literal notranslate"><span class="pre">Next</span></code> button.</p>
<p>A copy of this script can be found on Andy’s github page located <a class="reference external" href="https://github.com/andrewjahn/SPM_Scripts/blob/master/RunPreproc_1stLevel_job.m">here</a>. Note that the script is set up to analyze all 26 subjects in the dataset.</p>
</section>
<section id="video">
<h2>Video<a class="headerlink" href="#video" title="Link to this heading"></a></h2>
<p>For a video tutorial of how to script your analysis in SPM, click <a class="reference external" href="https://www.youtube.com/watch?v=-1m8nriF11I">here</a>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="SPM_Statistics/SPM_06_Stats_Running_1stLevel_Analysis.html" class="btn btn-neutral float-left" title="Chapter 6: Running the First-Level Analysis" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="SPM_07_SettingTheOrigin.html" class="btn btn-neutral float-right" title="SPM Tutorial #7: Setting the Origin" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Andy Jahn.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>