<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Appendix A: Cluster Correction &mdash; Andy&#39;s Brain Book 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b76e3c8a" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Appendix B: Biased Analysis" href="Appendix_B_BiasedAnalysis.html" />
    <link rel="prev" title="fMRI Short Course: Appendices" href="../fMRI_Appendices.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Andy's Brain Book
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Install</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation/fsl_mac_install.html">Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Unix for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_Intro.html">What is Unix?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_01_Navigation.html">Unix Tutorial #1: 目录操作 (Directories and Navigation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_02_CopyRemove.html">Unix Tutorial #2: Copying and Removing Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_03_ReadingTextFiles.html">Unix Tutorial #3: Reading Text Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_04_ShellsVariables.html">Unix Tutorial #4: Shells and Path Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_05_ForLoops.html">Unix Tutorial #5: For-Loops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_06_IfElse.html">Unix Tutorial #6: Conditional Statements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_07_Scripting.html">Unix Tutorial #7: Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_08_Sed.html">Unix Tutorial #8: The Sed Command</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_09_AutomatingTheAnalysis.html">Unix Tutorial #9: Automating The Analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">fMRI Short Course with FSL</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../fMRI_Intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fMRI_01_DataDownload.html">fMRI Tutorial #1: Downloading the Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fMRI_02_ExperimentalDesign.html">fMRI Tutorial #2: Overview of The Flanker Task</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fMRI_03_LookingAtTheData.html">fMRI Tutorial #3: Looking at the Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fMRI_04_Preprocessing.html">fMRI Tutorial #4: Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fMRI_05_1stLevelAnalysis.html">fMRI Tutorial #5: Statistics and Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fMRI_06_Scripting.html">fMRI Tutorial #6: Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fMRI_07_2ndLevelAnalysis.html">fMRI Tutorial #7: 2nd-Level Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fMRI_08_3rdLevelAnalysis.html">fMRI Tutorial #8: 3rd-Level Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fMRI_09_ROIAnalysis.html">fMRI Tutorial #9: ROI Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fMRI_10_Summary.html">fMRI Tutorial #10: Summary</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../fMRI_Appendices.html">fMRI Short Course: Appendices</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../fMRI_Appendices.html#introduction">Introduction</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Appendix A: Cluster Correction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-problem-of-multiple-comparisons">The Problem of Multiple Comparisons</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bonferroni-correction">Bonferroni Correction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#problems-with-bonferroni-correction">Problems with Bonferroni Correction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cluster-correction">Cluster Correction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#video">Video</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="Appendix_B_BiasedAnalysis.html">Appendix B: Biased Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="Appendix_C_Figures.html">Appendix C: Figures</a></li>
<li class="toctree-l3"><a class="reference internal" href="Appendix_D_OtherStats.html">Appendix D: Other Statistical Scenarios</a></li>
<li class="toctree-l3"><a class="reference internal" href="Appendix_E_Meta_Analysis.html">Appendix E: Meta-Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="Appendix_F_ParametricModulation.html">Appendix F: Parametric Modulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="Appendix_G_ReverseInference.html">Appendix G: Reverse Inference</a></li>
<li class="toctree-l3"><a class="reference internal" href="Appendix_H_DoubleDissociations.html">Appendix H: Double Dissociations</a></li>
<li class="toctree-l3"><a class="reference internal" href="Appendix_I_ICA_Denoising.html">Appendix I: Independent Components Analysis (ICA) with FSL and FIX</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FreeSurfer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FreeSurfer/FreeSurfer_Introduction.html">FreeSurfer Short Course</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">E-Prime</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../E-Prime/E-Prime_Overview.html">Overview of E-Prime</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">AFNI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../AFNI/AFNI_Overview.html">AFNI Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SPM</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../SPM/SPM_Overview.html">SPM Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Functional Connectivity with the CONN Toolbox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FunctionalConnectivity/CONN_Overview.html">Functional Connectivity and the CONN Toolbox</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Parametric Modulation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../PM/PM_Overview.html">Parametric Modulation in SPM, FSL, and AFNI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Image Visualization with MRIcroGL</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../MRIcroGL/MRIcroGL_Overview.html">Image Visualization with MRIcroGL</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Introduction to the Human Connectome Project (HCP)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../HCP/HCP_Overview.html">Introduction to the Human Connectome Project</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Finite Impulse Response (FIR) Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FIR/FIR_Overview.html">Finite Impulse Response (FIR)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">fMRI Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Practicals/DesignOptimization.html">Design Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Diffusion Analysis with MRtrix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../MRtrix/MRtrix_Introduction.html">Introduction to MRtrix</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ASL Analysis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/ASL_Techniques.html">fASL Tutorial #1: Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/fASL_02_Download.html">fASL Tutorial #2: Downloading and Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/fASL_03_Task.html">fASL Tutorial #3: The N-Back Task</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/04_fASL_GUI.html">fASL Tutorial #4: The GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/05_fASL_Results.html">fASL Tutorial #5: Examining the Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/06_fASL_Quantification.html">fASL Tutorial #6: Quantification</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Frequently Asked Questions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FrequentlyAskedQuestions/FrequentlyAskedQuestions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Statistics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Statistics/GIMME.html">GIMME (Group Iterative Multiple Model Estimation)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Open Science</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../OpenScience/OS_Overview.html">Open Science</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Normalization Tools (ANTs)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ANTs/ANTs_Overview.html">Advanced Normalization Tools (ANTs)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tract-Based Spatial Statistics (TBSS)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../TBSS/TBSS_Overview.html">Introduction to Tract-Based Spatial Statistics (TBSS)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Statistics for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Stats/Stats_Overview.html">Statistics for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Machine Learning for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ML/ML_Overview.html">Machine Learning for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Slicer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Slicer/Slicer_Overview.html">Slicer Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CAT12</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CAT12/CAT12_Overview.html">Voxel-Based Morphometry with CAT12</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using the Supercomputer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Supercomputer/Supercomputer_Overview.html">Introduction to Supercomputing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Matlab for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Matlab/Matlab_Overview.html">Matlab for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ITK-Snap</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ITK-Snap/ITK-Snap_Overview.html">ITK-Snap_Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../PythonForNeuroimagers/PythonForNeuroimagers_Overview.html">Python for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Meta-Analysis for fMRI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../MetaAnalysis/MetaAnalysis_Overview.html">Meta-Analysis for Neuroimagers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Andy's Brain Book</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../fMRI_Appendices.html">fMRI Short Course: Appendices</a></li>
      <li class="breadcrumb-item active">Appendix A: Cluster Correction</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/fMRI_Short_Course/fMRI_Appendices/Appendix_A_ClusterCorrection.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="appendix-a-cluster-correction">
<span id="appendix-a-clustercorrection"></span><h1>Appendix A: Cluster Correction<a class="headerlink" href="#appendix-a-cluster-correction" title="Link to this heading"></a></h1>
<hr class="docutils" />
<section id="the-problem-of-multiple-comparisons">
<h2>The Problem of Multiple Comparisons<a class="headerlink" href="#the-problem-of-multiple-comparisons" title="Link to this heading"></a></h2>
<p>In the fMRI tutorial you just completed, you learned that group-level contrast maps are created through a <strong>mass univariate analysis</strong>: in other words, we carry out as many statistical tests as there are voxels. Given that a typical fMRI dataset contains hundreds of thousands of voxels, this can lead to a large number of false positives. To control for the number of false positives, therefore, and to keep them at the conventional level of 5%, we will need to do something called <strong>multiple comparisons correction</strong>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For most statistical tests, we set the <strong>false positive rate</strong>, also known as the <strong>alpha level</strong>, to 0.05, or 5%. This is the probability that we will reject the null hypothesis if the null hypothesis is true; in other words, it is the probability that we will observe a false positive.</p>
</div>
<p>Failing to correct for multiple comparisons can lead to results that are unreliable and sometimes absurd. To illustrate this, and to make a point that presumably could not be made any other way, a researcher named Craig Bennet put a dead salmon into a scanner, showed it pictures of humans talking, playing, and socializing, and then analyzed the data as if it were any other study - only without correcting for multiple comparisons. The significant voxels consequently found in the salmon’s brain were clearly artifacts caused by noise; the message being that a certain number of voxels will pass a significance threshold regardless of whether there is a true effect or not.</p>
<figure class="align-default" id="id1">
<img alt="../../_images/Bennet_2009.png" src="../../_images/Bennet_2009.png" />
<figcaption>
<p><span class="caption-text">The famous “Dead Salmon” picture from Bennet et al. (2009).</span><a class="headerlink" href="#id1" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="bonferroni-correction">
<h2>Bonferroni Correction<a class="headerlink" href="#bonferroni-correction" title="Link to this heading"></a></h2>
<p>If we want to carry out several tests - as is commonly done in many studies - then what can be done to protect ourselves from mistaking false positives for true effects? The most straightforward method is called <strong>Bonferroni Correction</strong>, named after the Italian mathematician Carlo Bonferroni. Simply take your alpha level - traditionally set at 5% - and divide it by the number of tests.</p>
<p>This works well enough for behavioral studies consisting of a handful of tests, but quickly becomes unreasonable when applied to imaging data. For example, if your group-level contrast map contains 100,000 voxels and your alpha level is 0.05, an individual voxel will have to pass a corrected alpha level of 0.05/100,000 = 0.0000005 in order to be judged statistically significant. Either the effect must be phenomenally strong, or the study highly powered, for a voxel to reach this threshold; but effects are often not that strong, and imaging studies are usually not that highly powered. But if we want to use another correction method, first we will need to make the case for why Bonferroni Correction isn’t appropriate for imaging studies.</p>
</section>
<section id="problems-with-bonferroni-correction">
<h2>Problems with Bonferroni Correction<a class="headerlink" href="#problems-with-bonferroni-correction" title="Link to this heading"></a></h2>
<p>One of the assumptions of Bonferroni correction is that each test is independent. To take our fMRI dataset as an example, that would mean that each voxel is completely independent of every other voxel in the brain; knowing the value of one voxel doesn’t tell you anything about any other voxel.</p>
<p>But are the voxels completely independent? Let’s take a look at a typical fMRI image. Notice that a given voxel is similar to its neighbors: Bright voxels tend to be surrounded by brighter voxels, and darker voxels tend to be surrounded by darker voxels. Since we can make a relatively close estimate about what the signal intensity will look like for a voxel given its neighbors, the voxels are not completely independent. (The same logic extends to the timecourse at each voxel as well.)</p>
<figure class="align-default" id="id2">
<img alt="../../_images/ClusterCorrection_Autocorrelation_Example.png" src="../../_images/ClusterCorrection_Autocorrelation_Example.png" />
<figcaption>
<p><span class="caption-text">A typical fMRI image (left) with the inset showing an enlarged picture of the voxels at the center (right). Notice that the center voxel of region A is surrounded mostly by darker voxels, while the center voxel of region B is surrounded mostly by lighter voxels.</span><a class="headerlink" href="#id2" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Bonferroni correction, then, is too severe. Although you are virtually guaranteed to keep your false positive rate below 5%, this is likely to result in a high false negative rate - that is, failing to reject the null hypothesis when there actually is an effect. And although the debate goes on as to which type of false result is worse, in our case it would be preferable to do without Bonferroni correction altogether.</p>
</section>
<section id="cluster-correction">
<h2>Cluster Correction<a class="headerlink" href="#cluster-correction" title="Link to this heading"></a></h2>
<p>Fortunately, there is an alternative known as <strong>cluster correction</strong>, which is the most popular correction method in fMRI analysis (<a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S1053811914000020">Woo et al., 2014</a>). Cluster correction takes advantage of the fact that the voxels in a typical dataset are not completely independent: Instead of testing each voxel individually, <em>clusters</em> of voxels are tested for significance.</p>
<p>To illustrate this, let’s take a coronal slice from the incongruent-congruent group-level contrast you created in the fMRI tutorial. Notice how the brighter colors can be grouped into distinct clusters; if we tilt this slice into a three-dimensional view, we can see how clusters of voxels clump together into what looks like mountain ranges. Seen from this angle, the height of an individual voxel is determined by its z-value: Higher z-values correspond to higher peaks. The threshold that we apply is a cross-section through the mountains at a certain height - for example, a z-value of 3.1, corresponding to a p-value of 0.001 - and we only observe the peaks that remain after applying this threshold. This is known as <strong>thresholding</strong> the image, or, more specifically, setting a <strong>cluster-defining threshold</strong>, since only those voxels that are at or above that threshold will remain - and this threshold is the value that you see in the Post-stats tab of the FEAT GUI.</p>
<figure class="align-default">
<img alt="../../_images/Zstat_Peak_Demo.gif" src="../../_images/Zstat_Peak_Demo.gif" />
</figure>
<p>You may think that’s all we need to do; but a cluster-defining threshold is not the same as an alpha level. It could be that clusters as large as the ones in our group analysis are just as likely to be found in images created from pure noise. What we need to ask ourselves at this point is, How many clusters of a given size would be expect to observe due to chance? Let’s say that our cluster in the medial prefrontal cortex is 50 voxels large; how often would we expect a cluster that size to be generated by noise?</p>
<p>To answer this we run simulations - in other words, we create artifical datasets with the same dimensions and smoothness as our task dataset, but which are composed of pure noise. We then write down the size of the largest cluster, and repeat the process with another simulated dataset. If we do this thousands of times, we can create a distribution of maximum cluster sizes - and from this, we can calculate the percentage of the time we would observe a cluster as large as the one we generated from our task dataset.  If that percentage is lower than our alpha level of 5%, we can reject the null hypothesis.</p>
<section id="afni-s-3dfwhmx-and-3dclustsim">
<h3>AFNI’s 3dFWHMx and 3dClustSim<a class="headerlink" href="#afni-s-3dfwhmx-and-3dclustsim" title="Link to this heading"></a></h3>
<p>AFNI’s cluster correction method requires the user to estimate the smoothness of the data, and to then use those smoothness estimates to determine a threshold for significant clusters.</p>
<p>To do this, you will first need to run 3dFWHMx on a subject’s errts file, which contains the residuals of everything that wasn’t modeled - in other words, noise. For example, from sub-01’s sub-01.results directory, type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">3</span><span class="n">dFWHMx</span> <span class="o">-</span><span class="n">mask</span> <span class="n">mask_group</span><span class="o">+</span><span class="n">tlrc</span> <span class="o">-</span><span class="nb">input</span> <span class="n">errts</span><span class="o">.</span><span class="n">sub</span><span class="o">-</span><span class="mi">01</span><span class="n">_REML</span><span class="o">+</span><span class="n">tlrc</span> <span class="o">-</span><span class="n">acf</span>
</pre></div>
</div>
<p>Which will output numbers like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">0.827124</span> <span class="mf">2.9802</span> <span class="mf">5.31313</span>    <span class="mf">7.16512</span>
</pre></div>
</div>
<p>The first three numbers are the parameters needed to create the <strong>autocorrelation function</strong>, a model of how correlated a given voxel is with its neighbors; the last number is the estimated smoothness of the data, in millimeters. Note that it will be higher than the smoothing kernel that you use, since the kernel is applied to smoothness that is already in the data.</p>
<p>These numbers can then be used with 3dClustSim, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">3</span><span class="n">dClustSim</span> <span class="o">-</span><span class="n">mask</span> <span class="n">mask_group</span><span class="o">+</span><span class="n">tlrc</span> <span class="o">-</span><span class="n">acf</span> <span class="mf">0.827</span> <span class="mf">2.980</span> <span class="mf">5.313</span> <span class="o">-</span><span class="n">athr</span> <span class="mf">0.05</span> <span class="o">-</span><span class="n">pthr</span> <span class="mf">0.001</span>
</pre></div>
</div>
<p>In which <code class="docutils literal notranslate"><span class="pre">athr</span></code> indicates the overall alpha threshold for the clusters, which we will leave at the conventional level of 0.05, and <code class="docutils literal notranslate"><span class="pre">pthr</span></code> indicates the uncorrected cluster-forming p-threshold.</p>
<p>This will generate a table that shows the number of contiguous voxels that are neeeded for a cluster to be deemed statistically significant. For example, the output may look like this:</p>
<figure class="align-default">
<img alt="../../_images/3dClustSim_Table.png" src="../../_images/3dClustSim_Table.png" />
</figure>
<p>Which indicates that, for a cluster-defining threshold of p=0.001, a cluster is significant if it is composed of 8.6 or more voxels. (To be safe, round up to the next highest integer, even if the determined cluster size is 8.1. In this example, we would only include those clusters of 9 or more voxels.)</p>
<p>In addition, the table includes permutations of different “NN” and “N-sided” values. Below is a glossary of what these abbreviations mean:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NN1</span> <span class="o">-</span> <span class="n">Voxels</span> <span class="n">are</span> <span class="n">contiguous</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="p">,</span> <span class="n">part</span> <span class="n">of</span> <span class="n">the</span> <span class="n">same</span> <span class="n">cluster</span><span class="p">)</span> <span class="k">if</span> <span class="n">the</span> <span class="n">faces</span> <span class="n">touch</span>
<span class="n">NN2</span> <span class="o">-</span> <span class="n">Faces</span> <span class="n">OR</span> <span class="n">edges</span> <span class="n">need</span> <span class="n">to</span> <span class="n">touch</span>
<span class="n">NN3</span> <span class="o">-</span> <span class="n">Faces</span> <span class="n">OR</span> <span class="n">edges</span> <span class="n">OR</span> <span class="n">corners</span> <span class="n">need</span> <span class="n">to</span> <span class="n">touch</span>

<span class="mi">1</span><span class="o">-</span><span class="n">sided</span> <span class="o">-</span> <span class="n">Voxels</span> <span class="n">are</span> <span class="n">contiguous</span> <span class="k">if</span> <span class="n">they</span> <span class="n">have</span> <span class="n">the</span> <span class="n">same</span> <span class="n">sign</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="p">,</span> <span class="n">only</span> <span class="n">looking</span> <span class="n">at</span> <span class="n">voxels</span> <span class="n">where</span> <span class="n">A</span><span class="o">&gt;</span><span class="n">B</span><span class="p">)</span>
<span class="mi">2</span><span class="o">-</span><span class="n">sided</span> <span class="o">-</span> <span class="n">Voxels</span> <span class="n">are</span> <span class="n">contiguous</span> <span class="k">if</span> <span class="n">they</span> <span class="n">are</span> <span class="n">either</span> <span class="n">positive</span> <span class="ow">or</span> <span class="n">negative</span>
<span class="n">bi</span><span class="o">-</span><span class="n">sided</span> <span class="o">-</span> <span class="n">Separate</span> <span class="n">the</span> <span class="n">clusters</span> <span class="k">if</span> <span class="n">the</span> <span class="n">voxels</span> <span class="n">have</span> <span class="n">different</span> <span class="n">signs</span>
</pre></div>
</div>
</section>
<section id="fsl-s-randomise">
<h3>FSL’s Randomise<a class="headerlink" href="#fsl-s-randomise" title="Link to this heading"></a></h3>
<p>FSL has a command called <code class="docutils literal notranslate"><span class="pre">Randomise</span></code>, which creates a distribution from the data by randomly permuting the signs of the contrasts that are specified. For example, if you had a between-subjects design with 20 subjects in each group, and you had created the design matrix through the FEAT GUI, you could run something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">randomise</span> <span class="o">-</span><span class="n">i</span> <span class="n">allZs</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="o">-</span><span class="n">o</span> <span class="n">allZs</span> <span class="o">-</span><span class="n">d</span> <span class="n">Unfair</span><span class="o">-</span><span class="n">Fair_Rejected</span><span class="o">-</span><span class="n">Accepted</span><span class="o">.</span><span class="n">mat</span> <span class="o">-</span><span class="n">con</span> <span class="n">Unfair</span><span class="o">-</span><span class="n">Fair_Rejected</span><span class="o">-</span><span class="n">Accepted</span><span class="o">.</span><span class="n">con</span> <span class="o">-</span><span class="n">n</span> <span class="mi">1000</span> <span class="o">-</span><span class="n">T</span>
</pre></div>
</div>
<p>“allZs.nii.gz” is a file of the combined zstat images from both groups, created using fslmerge. The .mat and .con files are created using the Setup Model Wizard from the FEAT GUI. Usually about 5000 permutations or more should be selected in order to create a robust distribution.</p>
<p>Alternatively, if you are running permutations on a one-sample t-test, you can use shorthand to omit the design and contrast files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">randomise</span> <span class="o">-</span><span class="n">i</span> <span class="n">allZstats</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="o">-</span><span class="n">o</span> <span class="n">allZstats_randomise</span><span class="o">.</span><span class="n">nii</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span><span class="n">T</span> <span class="o">-</span><span class="n">n</span> <span class="mi">500</span>
</pre></div>
</div>
<p>Randomise can also be run from the 3rd-level analysis. If you navigate to your 3rd-level directory, open FEAT, and load the design.fsf file, click on the <code class="docutils literal notranslate"><span class="pre">Stats</span></code> tab and change <code class="docutils literal notranslate"><span class="pre">FLAME1</span></code> to <code class="docutils literal notranslate"><span class="pre">Randomise</span></code>:</p>
<figure class="align-default">
<img alt="../../_images/CC_StatsTab_Randomise.png" src="../../_images/CC_StatsTab_Randomise.png" />
</figure>
<p>On the post-stats tab under <code class="docutils literal notranslate"><span class="pre">Thresholding</span></code>, <code class="docutils literal notranslate"><span class="pre">TFCE</span></code> is now an option that you can choose:</p>
<figure class="align-default">
<img alt="../../_images/CC_PostStatsTab_Randomise.png" src="../../_images/CC_PostStatsTab_Randomise.png" />
</figure>
</section>
<section id="spm-s-cluster-correction">
<h3>SPM’s Cluster Correction<a class="headerlink" href="#spm-s-cluster-correction" title="Link to this heading"></a></h3>
<p>SPM will automatically calculate whether a given cluster is significant, given the cluster-defining threshold you specify in the “Results” window.</p>
<figure class="align-default">
<img alt="../../_images/SPM_ClusterTable.png" src="../../_images/SPM_ClusterTable.png" />
</figure>
<p>You can see the threshold at the very bottom of the results screen, next to FWEc. In this case, using a voxel-wise threshold of p=0.001, a cluster of 79 voxels or more is needed to be statistically significant. Here’s a breakdown of what the different labels mean:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FWEp</span><span class="p">:</span> <span class="mf">6.132</span> <span class="o">-&gt;</span> <span class="n">an</span> <span class="n">individual</span> <span class="n">voxel</span> <span class="n">needs</span> <span class="n">a</span> <span class="n">z</span><span class="o">-</span><span class="n">value</span> <span class="n">of</span> <span class="mf">6.132</span> <span class="ow">or</span> <span class="n">greater</span> <span class="n">to</span> <span class="k">pass</span> <span class="n">a</span> <span class="n">Bonferroni</span><span class="o">-</span><span class="n">corrected</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.05</span> <span class="n">alpha</span> <span class="n">threshold</span>
<span class="n">FDRp</span><span class="p">:</span> <span class="mf">6.085</span> <span class="o">-&gt;</span> <span class="n">an</span> <span class="n">individual</span> <span class="n">voxel</span> <span class="n">needs</span> <span class="n">a</span> <span class="n">z</span><span class="o">-</span><span class="n">value</span> <span class="n">of</span> <span class="mf">6.085</span> <span class="ow">or</span> <span class="n">greater</span> <span class="n">to</span> <span class="k">pass</span> <span class="n">an</span> <span class="n">FDR</span><span class="o">-</span><span class="n">corrected</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.05</span> <span class="n">alpha</span> <span class="n">threshold</span>
<span class="n">FWEc</span><span class="p">:</span> <span class="mi">79</span> <span class="o">-&gt;</span> <span class="n">For</span> <span class="n">the</span> <span class="n">currently</span> <span class="n">selected</span> <span class="n">cluster</span><span class="o">-</span><span class="n">forming</span> <span class="n">threshold</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span> <span class="n">a</span> <span class="n">cluster</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">composed</span> <span class="n">of</span> <span class="mi">79</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">contiguous</span> <span class="n">voxels</span> <span class="n">to</span> <span class="k">pass</span> <span class="n">an</span> <span class="n">FWE</span> <span class="n">correction</span> <span class="n">of</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">FDRc</span><span class="p">:</span> <span class="mi">44</span> <span class="o">-&gt;</span> <span class="n">For</span> <span class="n">the</span> <span class="n">currently</span> <span class="n">selected</span> <span class="n">cluster</span><span class="o">-</span><span class="n">forming</span> <span class="n">threshold</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span> <span class="n">a</span> <span class="n">cluster</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">composed</span> <span class="n">of</span> <span class="mi">44</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">contiguous</span> <span class="n">voxels</span> <span class="n">to</span> <span class="k">pass</span> <span class="n">an</span> <span class="n">FDR</span> <span class="n">correction</span> <span class="n">of</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.05</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="../../_images/SPM_ClusterThr.png" src="../../_images/SPM_ClusterThr.png" />
</figure>
<p>If you want to use AFNI’s 3dClustSim on the preprocessed SPM data - for example, because you <a class="reference external" href="https://www.pnas.org/content/113/28/7900.short">trust AFNI’s cluster correction threshold more than SPM’s</a> - you will need to <a class="reference external" href="https://andysbrainbook.readthedocs.io/en/latest/SPM/SPM_Short_Course/SPM_Statistics/SPM_06_Stats_Running_1stLevel_Analysis.html#estimating-the-model">save the residuals</a> when running the 1st-level analysis.</p>
<p>When you have created the residuals, using the following code to concatenate the residuals into a single dataset:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">3</span><span class="n">dTcat</span> <span class="o">-</span><span class="n">prefix</span> <span class="n">allRes</span><span class="o">.</span><span class="n">nii</span> <span class="n">Res</span><span class="o">*</span>
</pre></div>
</div>
<p>Then run 3dFWHMx on the concatenated residual dataset:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">3</span><span class="n">dFWHMx</span> <span class="o">-</span><span class="n">mask</span> <span class="n">mask</span><span class="o">.</span><span class="n">nii</span> <span class="o">-</span><span class="n">acf</span> <span class="o">-</span><span class="nb">input</span> <span class="n">allRes</span><span class="o">.</span><span class="n">nii</span>
</pre></div>
</div>
<p>Then follow the steps above for running 3dClustSim on the resulting ACF values.</p>
</section>
</section>
<hr class="docutils" />
<section id="video">
<h2>Video<a class="headerlink" href="#video" title="Link to this heading"></a></h2>
<p>For an overview of cluster correction and how it works, watch <a class="reference external" href="https://www.youtube.com/watch?v=hM0dC4OTCvU">this video</a>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../fMRI_Appendices.html" class="btn btn-neutral float-left" title="fMRI Short Course: Appendices" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Appendix_B_BiasedAnalysis.html" class="btn btn-neutral float-right" title="Appendix B: Biased Analysis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Andy Jahn.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>