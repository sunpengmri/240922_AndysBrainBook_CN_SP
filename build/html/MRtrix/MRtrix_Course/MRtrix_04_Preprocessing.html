<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MRtrix Tutorial #4: Preprocessing &mdash; Andy&#39;s Brain Book 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b76e3c8a" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="MRtrix Tutorial #5: Constrained Spherical Deconvolution" href="MRtrix_05_BasisFunctions.html" />
    <link rel="prev" title="MRtrix Tutorial #3: Looking at the Data" href="MRtrix_03_DataFormats.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Andy's Brain Book
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Install</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation/fsl_mac_install.html">Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Unix for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_Intro.html">What is Unix?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_01_Navigation.html">Unix Tutorial #1: 目录操作 (Directories and Navigation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_02_CopyRemove.html">Unix Tutorial #2: Copying and Removing Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_03_ReadingTextFiles.html">Unix Tutorial #3: Reading Text Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_04_ShellsVariables.html">Unix Tutorial #4: Shells and Path Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_05_ForLoops.html">Unix Tutorial #5: For-Loops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_06_IfElse.html">Unix Tutorial #6: Conditional Statements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_07_Scripting.html">Unix Tutorial #7: Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_08_Sed.html">Unix Tutorial #8: The Sed Command</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_09_AutomatingTheAnalysis.html">Unix Tutorial #9: Automating The Analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">fMRI Short Course with FSL</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_Intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_01_DataDownload.html">fMRI Tutorial #1: Downloading the Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_02_ExperimentalDesign.html">fMRI Tutorial #2: Overview of The Flanker Task</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_03_LookingAtTheData.html">fMRI Tutorial #3: Looking at the Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_04_Preprocessing.html">fMRI Tutorial #4: Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_05_1stLevelAnalysis.html">fMRI Tutorial #5: Statistics and Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_06_Scripting.html">fMRI Tutorial #6: Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_07_2ndLevelAnalysis.html">fMRI Tutorial #7: 2nd-Level Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_08_3rdLevelAnalysis.html">fMRI Tutorial #8: 3rd-Level Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_09_ROIAnalysis.html">fMRI Tutorial #9: ROI Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_10_Summary.html">fMRI Tutorial #10: Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_Appendices.html">fMRI Short Course: Appendices</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FreeSurfer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FreeSurfer/FreeSurfer_Introduction.html">FreeSurfer Short Course</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">E-Prime</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../E-Prime/E-Prime_Overview.html">Overview of E-Prime</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">AFNI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../AFNI/AFNI_Overview.html">AFNI Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SPM</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../SPM/SPM_Overview.html">SPM Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Functional Connectivity with the CONN Toolbox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FunctionalConnectivity/CONN_Overview.html">Functional Connectivity and the CONN Toolbox</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Parametric Modulation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../PM/PM_Overview.html">Parametric Modulation in SPM, FSL, and AFNI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Image Visualization with MRIcroGL</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../MRIcroGL/MRIcroGL_Overview.html">Image Visualization with MRIcroGL</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Introduction to the Human Connectome Project (HCP)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../HCP/HCP_Overview.html">Introduction to the Human Connectome Project</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Finite Impulse Response (FIR) Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FIR/FIR_Overview.html">Finite Impulse Response (FIR)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">fMRI Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Practicals/DesignOptimization.html">Design Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Diffusion Analysis with MRtrix</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../MRtrix_Introduction.html">Introduction to MRtrix</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../MRtrix_Introduction.html#what-is-mrtrix">What is MRtrix?</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../MRtrix_Introduction.html#goals-of-this-course">Goals of This Course</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="MRtrix_00_Diffusion_Overview.html">MRtrix Introduction: Overview of Diffusion Imaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_01_Download_Install.html">MRtrix Tutorial #1: Download and Install</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_02_DataDownload.html">MRtrix Tutorial #2: Downloading the Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_03_DataFormats.html">MRtrix Tutorial #3: Looking at the Data</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">MRtrix Tutorial #4: Preprocessing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dwi-denoise">dwi_denoise</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mri-degibbs">mri_degibbs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#extracting-the-reverse-phase-encoded-images">Extracting the Reverse Phase-Encoded Images</a></li>
<li class="toctree-l4"><a class="reference internal" href="#putting-it-all-together-preprocessing-with-dwipreproc">Putting It All Together: Preprocessing with dwipreproc</a></li>
<li class="toctree-l4"><a class="reference internal" href="#generating-a-mask">Generating a Mask</a></li>
<li class="toctree-l4"><a class="reference internal" href="#video">Video</a></li>
<li class="toctree-l4"><a class="reference internal" href="#next-steps">Next Steps</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_05_BasisFunctions.html">MRtrix Tutorial #5: Constrained Spherical Deconvolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_06_TissueBoundary.html">MRtrix Tutorial #6: Creating the Tissue Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_07_Streamlines.html">MRtrix Tutorial #7: Streamlines</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_08_Connectome.html">MRtrix Tutorial #8: Creating and Viewing the Connectome</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_09_Scripting.html">MRtrix Tutorial #9: Scripting</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_10_GroupAnalysis.html">MRtrix Tutorial #10: Group-Level Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_11_FixelBasedAnalysis.html">MRtrix Tutorial #11: Fixel-Based Analysis</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ASL Analysis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/ASL_Techniques.html">fASL Tutorial #1: Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/fASL_02_Download.html">fASL Tutorial #2: Downloading and Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/fASL_03_Task.html">fASL Tutorial #3: The N-Back Task</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/04_fASL_GUI.html">fASL Tutorial #4: The GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/05_fASL_Results.html">fASL Tutorial #5: Examining the Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/06_fASL_Quantification.html">fASL Tutorial #6: Quantification</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Frequently Asked Questions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FrequentlyAskedQuestions/FrequentlyAskedQuestions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Statistics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Statistics/GIMME.html">GIMME (Group Iterative Multiple Model Estimation)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Open Science</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../OpenScience/OS_Overview.html">Open Science</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Normalization Tools (ANTs)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ANTs/ANTs_Overview.html">Advanced Normalization Tools (ANTs)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tract-Based Spatial Statistics (TBSS)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../TBSS/TBSS_Overview.html">Introduction to Tract-Based Spatial Statistics (TBSS)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Statistics for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Stats/Stats_Overview.html">Statistics for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Machine Learning for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ML/ML_Overview.html">Machine Learning for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Slicer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Slicer/Slicer_Overview.html">Slicer Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CAT12</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CAT12/CAT12_Overview.html">Voxel-Based Morphometry with CAT12</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using the Supercomputer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Supercomputer/Supercomputer_Overview.html">Introduction to Supercomputing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Matlab for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Matlab/Matlab_Overview.html">Matlab for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ITK-Snap</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ITK-Snap/ITK-Snap_Overview.html">ITK-Snap_Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../PythonForNeuroimagers/PythonForNeuroimagers_Overview.html">Python for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Meta-Analysis for fMRI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../MetaAnalysis/MetaAnalysis_Overview.html">Meta-Analysis for Neuroimagers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Andy's Brain Book</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../MRtrix_Introduction.html">Introduction to MRtrix</a></li>
      <li class="breadcrumb-item active">MRtrix Tutorial #4: Preprocessing</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/MRtrix/MRtrix_Course/MRtrix_04_Preprocessing.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mrtrix-tutorial-4-preprocessing">
<span id="mrtrix-04-preprocessing"></span><h1>MRtrix Tutorial #4: Preprocessing<a class="headerlink" href="#mrtrix-tutorial-4-preprocessing" title="Link to this heading"></a></h1>
<hr class="docutils" />
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>Just like other neuroimaging data, diffusion data should be <strong>preprocessed</strong> before it is analyzed. Preprocessing removes sources of noise from the image, such as movement artifacts and other distortions. Diffusion data in particular is susceptible to <strong>warping artifacts</strong> as a result of the phase-encoding direction: In general, the predominant encoding direction - such as Anterior to Posterior, or AP - will make the anterior part of the brain look more “squished”, as though a strong headwind is blowing from the Anterior direction. The opposite is true of the Posterior to Anterior, or PA, phase-encoding direction. Sometimes these distortions are very subtle, but other times they are conspicuous:</p>
<figure class="align-default">
<img alt="../../_images/04_AP_PA_Comparisons.png" src="../../_images/04_AP_PA_Comparisons.png" />
</figure>
<p>The following are common preprocessing steps done with MRtrix. If you have used the software package FSL to analyze diffusion data, note that some of the FSL commands - such as eddy and topup - are used in some of the MRtrix libraries. We will explore that more below.</p>
</section>
<section id="dwi-denoise">
<h2>dwi_denoise<a class="headerlink" href="#dwi-denoise" title="Link to this heading"></a></h2>
<p>The first preprocessing step we will do is <strong>denoise</strong> the data by using MRtrix’s <code class="docutils literal notranslate"><span class="pre">dwidenoise</span></code> command. This requires an input and an output argument, and you also have the option to output the noise map with the <code class="docutils literal notranslate"><span class="pre">-noise</span></code> option. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dwidenoise</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_dwi</span><span class="o">.</span><span class="n">mif</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_den</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">noise</span> <span class="n">noise</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<p>This command should take a couple of minutes to run.</p>
<p>One quality check is to see whether the residuals load onto any part of the anatomy. If they do, that may indicate that the brain region is disproportionately affected by some kind of artifact or distortion. To calculate this residual, we will use another MRtrix command called <code class="docutils literal notranslate"><span class="pre">mrcalc</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mrcalc</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_dwi</span><span class="o">.</span><span class="n">mif</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_den</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">subtract</span> <span class="n">residual</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<p>You can then inspect the residual map with mrview:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mrview</span> <span class="n">residual</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="../../_images/04_residuals.png" src="../../_images/04_residuals.png" />
</figure>
<p>It is common to see a grey outline of the brain, as in the figure above. However, everything within the grey matter and white matter should be relatively uniform and blurry; if you see any clear anatomical landmarks, such as individual gyri or sulci, that may indicate that those parts of the brain have been corrupted by noise. If that happens, you can increase the extent of the denoising filter from the default of 5 to a larger number, such as 7; e.g.,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dwidenoise</span> <span class="n">your_data</span><span class="o">.</span><span class="n">mif</span> <span class="n">your_data_denoised_7extent</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">extent</span> <span class="mi">7</span> <span class="o">-</span><span class="n">noise</span> <span class="n">noise</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
</section>
<section id="mri-degibbs">
<h2>mri_degibbs<a class="headerlink" href="#mri-degibbs" title="Link to this heading"></a></h2>
<p>An optional preprocessing step is to run <code class="docutils literal notranslate"><span class="pre">mri_degibbs</span></code>, which removes <a class="reference external" href="http://mriquestions.com/gibbs-artifact.html">Gibbs’ ringing artifacts</a> from the data. These artifacts look like ripples in a pond, and are most conspicuous in the images that have a b-value of 0. Look at your diffusion data first with <code class="docutils literal notranslate"><span class="pre">mrview</span></code>, and determine whether there are any Gibbs artifacts; if there are, then you can run <code class="docutils literal notranslate"><span class="pre">mrdegibbs</span></code> by specifying both an input file and output file, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mrdegibbs</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_den</span><span class="o">.</span><span class="n">mif</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_den_unr</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<p>As always, inspect the data both before and after with <code class="docutils literal notranslate"><span class="pre">mrview</span></code> to determine whether the preprocessing step made the data better, worse, or had no effect.</p>
<p>If you don’t see any Gibbs artifacts in your data, then I would recommend omitting this step; we won’t be using it for the rest of the tutorial.</p>
</section>
<section id="extracting-the-reverse-phase-encoded-images">
<h2>Extracting the Reverse Phase-Encoded Images<a class="headerlink" href="#extracting-the-reverse-phase-encoded-images" title="Link to this heading"></a></h2>
<p>Most diffusion datasets are composed of two separate imaging files: One that is acquired with a primary phase-encoding direction, and one that is acquired with a reverse phase-encoding direction. The primary phase-encoding direction is used to acquire the majority of the diffusion images at different b-values. The reverse-phase encoded file, on the other hand, is used to <strong>unwarp</strong> any of the distortions that are present in the primary phase-encoded file.</p>
<p>To understand how this works, imagine that you are using a blow dryer on your hair. Let’s say that you have the blow dryer pointed at the back of your head, and it blows your hair forward, onto the front of your face; let’s call this the posterior-to-anterior (PA) phase-encoding direction. Right now your hair looks like a mess, and you want to undo the effects of the air blowing from the back of your head to the front of your head. So you point the blow dryer at the front of your face, and it blows your hair back. If you take the average between the two of those blow dryings, your hair should be back in its normal position.</p>
<p>Similarly, we use both phase-encoding directions to create a sort of average between the two. We know that both types of phase-encoding will introduce two separate and opposite distortions into the data, but we can use unwarping to cancel them out.</p>
<p>Our first step is to convert the reverse phase-encoded NIFTI file into .mif format. We will also add its b-values and b-vectors into the header:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mrconvert</span> <span class="n">sub</span><span class="o">-</span><span class="n">CON02_ses</span><span class="o">-</span><span class="n">preop_acq</span><span class="o">-</span><span class="n">PA_dwi</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">PA</span><span class="o">.</span><span class="n">mif</span>
<span class="n">mrconvert</span> <span class="n">PA</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">fslgrad</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_PA</span><span class="o">.</span><span class="n">bvec</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_PA</span><span class="o">.</span><span class="n">bval</span> <span class="o">-</span> <span class="o">|</span> <span class="n">mrmath</span> <span class="o">-</span> <span class="n">mean</span> <span class="n">mean_b0_PA</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">axis</span> <span class="mi">3</span>
</pre></div>
</div>
<p>Next, we extract the b-values from the primary phase-encoded image, and then combine the two with <code class="docutils literal notranslate"><span class="pre">mrcat</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dwiextract</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_den</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span> <span class="o">-</span><span class="n">bzero</span> <span class="o">|</span> <span class="n">mrmath</span> <span class="o">-</span> <span class="n">mean</span> <span class="n">mean_b0_AP</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">axis</span> <span class="mi">3</span>
<span class="n">mrcat</span> <span class="n">mean_b0_AP</span><span class="o">.</span><span class="n">mif</span> <span class="n">mean_b0_PA</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">axis</span> <span class="mi">3</span> <span class="n">b0_pair</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<p>This will create a new image, “b0_pair.mif”, which contains both of the average b=0 images for both phase-encoded images.</p>
</section>
<section id="putting-it-all-together-preprocessing-with-dwipreproc">
<h2>Putting It All Together: Preprocessing with dwipreproc<a class="headerlink" href="#putting-it-all-together-preprocessing-with-dwipreproc" title="Link to this heading"></a></h2>
<p>We now have everything we need to run the main preprocessing step, which is called by <code class="docutils literal notranslate"><span class="pre">dwipreproc</span></code>. For the most part, this command is a wrapper that uses FSL commands such as <code class="docutils literal notranslate"><span class="pre">topup</span></code> and <code class="docutils literal notranslate"><span class="pre">eddy</span></code> to unwarp the data and remove eddy currents. For this tutorial, we will use the following line of code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dwifslpreproc</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_den</span><span class="o">.</span><span class="n">mif</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_den_preproc</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">nocleanup</span> <span class="o">-</span><span class="n">pe_dir</span> <span class="n">AP</span> <span class="o">-</span><span class="n">rpe_pair</span> <span class="o">-</span><span class="n">se_epi</span> <span class="n">b0_pair</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">eddy_options</span> <span class="s2">&quot; --slm=linear --data_is_shelled&quot;</span>
</pre></div>
</div>
<p>The first arguments are the input and output; the second option, <code class="docutils literal notranslate"><span class="pre">-nocleanup</span></code>, will keep the temporary processing folder which contains a few files we will examine later. <code class="docutils literal notranslate"><span class="pre">-pe_dir</span> <span class="pre">AP</span></code> signalizes that the primary phase-encoding direction is anterior-to-posterior, and <code class="docutils literal notranslate"><span class="pre">-rpe_pair</span></code> combined with the <code class="docutils literal notranslate"><span class="pre">-se_epi</span></code> options indicates that the following input file (i.e., “b0_pair.mif”) is a pair of spin-echo images that were acquired with reverse phase-encoding directions. Lastly, <code class="docutils literal notranslate"><span class="pre">-eddy_options</span></code> specifies options that are specific to the FSL command <code class="docutils literal notranslate"><span class="pre">eddy</span></code>. You can visit the <a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/eddy/UsersGuide">eddy user guide</a> for more options and details about what they do. For now, we will only use the options <code class="docutils literal notranslate"><span class="pre">--slm=linear</span></code> (which can be useful for data that was acquired with less than 60 directions) and <code class="docutils literal notranslate"><span class="pre">--data_is_shelled</span></code> (which indicates that the diffusion data was acquired with multiple b-values).</p>
<p>This command can take several hours to run, depending on the speed of your computer. For an iMac with 8 processing cores, it takes roughly 2 hours. When it has finished, examine the output to see how eddy current correction and unwarping have changed the data; ideally, you should see more signal restored in regions such as the orbitofrontal cortex, which is particularly susceptible to signal dropout:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mrview</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_den_preproc</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">overlay</span><span class="o">.</span><span class="n">load</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_dwi</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<p>This command will display the newly preprocessed data, with the original diffusion data overlaid on top of it and colored in red. To see how the eddy currents were unwarped, open the Overlays tab and click on the box next to the image <code class="docutils literal notranslate"><span class="pre">sub-02_dwi.mif</span></code>. You should see a noticeable difference between the two images, especially in the frontal lobes of the brain near the eyes, which are most susceptible to eddy currents.</p>
<figure class="align-default">
<img alt="../../_images/04_BeforeAfterEddy.png" src="../../_images/04_BeforeAfterEddy.png" />
</figure>
<section id="checking-for-corrupt-slices">
<h3>Checking for Corrupt Slices<a class="headerlink" href="#checking-for-corrupt-slices" title="Link to this heading"></a></h3>
<p>One of the options in the <code class="docutils literal notranslate"><span class="pre">dwifslpreproc</span></code> command, “-nocleanup”, retained a directory with the string “tmp” in its title. Within this folder is a file called <code class="docutils literal notranslate"><span class="pre">dwi_post_eddy.eddy_outlier_map</span></code>, which contains strings of 0’s and 1’s. Each 1 represents a slice that is an outlier, either because of too much motion, eddy currents, or something else.</p>
<p>The following code, run from the <code class="docutils literal notranslate"><span class="pre">dwi</span></code> directory, will navigate into the “tmp” folder and calculate the percentage of outlier slices:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cd dwifslpreproc-tmp-*
totalSlices=`mrinfo dwi.mif | grep Dimensions | awk &#39;{print $6 * $8}&#39;`
totalOutliers=`awk &#39;{ for(i=1;i&lt;=NF;i++)sum+=$i } END { print sum }&#39; dwi_post_eddy.eddy_outlier_map`
echo &quot;If the following number is greater than 10, you may have to discard this subject because of too much motion or corrupted slices&quot;
echo &quot;scale=5; ($totalOutliers / $totalSlices * 100)/1&quot; | bc | tee percentageOutliers.txt
cd ..
</pre></div>
</div>
<p>The first two lines navigate into the “tmp” directory and calculate the total number of slices by multiplying the number of slices for a single volume by the total number of volumes in the dataset. The total number of 1’s in the outlier map is then calculated, and the percentage of outlier slices is generated by dividing the number of outlier slices by the total number of slices. If this number is greater than 10 - i.e., if more than 10 percent of the slices are flagged as outliers - you should consider removing the subject from further analyses.</p>
</section>
</section>
<section id="generating-a-mask">
<h2>Generating a Mask<a class="headerlink" href="#generating-a-mask" title="Link to this heading"></a></h2>
<p>As with fMRI analysis, it is useful to create a mask to restrict your analysis only to brain voxels; this will speed up the rest of your analyses.</p>
<p>To do that, it can be useful to run a command beforehand called <code class="docutils literal notranslate"><span class="pre">dwibiascorrect</span></code>. This can remove inhomogeneities detected in the data that can lead to a better mask estimation. However, it can in some cases lead to a worse estimation; as with all of the preprocessing steps, you should check it before and after each step:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dwibiascorrect</span> <span class="n">ants</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_den_preproc</span><span class="o">.</span><span class="n">mif</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_den_preproc_unbiased</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">bias</span> <span class="n">bias</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The command above uses the <code class="docutils literal notranslate"><span class="pre">-ants</span></code> option, which requires that ANTs be installed on your system. I recommend this program, but in case you are unable to install it, you can replace it with the <code class="docutils literal notranslate"><span class="pre">-fsl</span></code> option.</p>
</div>
<p>You are now ready to create the mask with <code class="docutils literal notranslate"><span class="pre">dwi2mask</span></code>, which will restrict your analysis to voxels that are located within the brain:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dwi2mask</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_den_preproc_unbiased</span><span class="o">.</span><span class="n">mif</span> <span class="n">mask</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<p>Check the output of this command by typing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mrview</span> <span class="n">mask</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<p>You should see something like the following:</p>
<figure class="align-default">
<img alt="../../_images/04_Mask.png" src="../../_images/04_Mask.png" />
</figure>
<p>MRtrix’s dwi2mask command works well in most scenarios. However, you can see from the above image that there are a few holes in the mask within the brainstem and the cerebellum. You may be uninterested in these regions, but it is still a good idea to make sure the mask doesn’t have any holes anywhere.</p>
<p>To that end, you could use a command such as FSL’s <code class="docutils literal notranslate"><span class="pre">bet2</span></code>. For example, you could use the following code to convert the unbiased diffusion-weighted image to NIFTI format, create a mask with <code class="docutils literal notranslate"><span class="pre">bet2</span></code>, and then convert the mask to .mif format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mrconvert</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_den_preproc_unbiased</span><span class="o">.</span><span class="n">mif</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_unbiased</span><span class="o">.</span><span class="n">nii</span>
<span class="n">bet2</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_unbiased</span><span class="o">.</span><span class="n">nii</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_masked</span> <span class="o">-</span><span class="n">m</span> <span class="o">-</span><span class="n">f</span> <span class="mf">0.7</span>
<span class="n">mrconvert</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span><span class="n">_masked_mask</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">mask</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<p>You may have to experiment with the fractional intensity threshold (specified by <code class="docutils literal notranslate"><span class="pre">-f</span></code>) in order to generate a mask that you are satisfied with. In my experience, this can vary between 0.2 and 0.7 for most brains in order to generate an adequate mask.</p>
</section>
<section id="video">
<h2>Video<a class="headerlink" href="#video" title="Link to this heading"></a></h2>
<p>A video overview of preprocessing in MRtrix can be found <a class="reference external" href="https://www.youtube.com/watch?v=W-NPz74oUzg">here</a>.</p>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading"></a></h2>
<p>Now that we have our preprocessed diffusion data and a mask, we are ready to do <strong>constrained spherical deconvolution</strong>, which we cover in the next chapter.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="MRtrix_03_DataFormats.html" class="btn btn-neutral float-left" title="MRtrix Tutorial #3: Looking at the Data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="MRtrix_05_BasisFunctions.html" class="btn btn-neutral float-right" title="MRtrix Tutorial #5: Constrained Spherical Deconvolution" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Andy Jahn.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>