<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MRtrix Tutorial #11: Fixel-Based Analysis &mdash; Andy&#39;s Brain Book 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b76e3c8a" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="fASL Tutorial #1: Background" href="../../ASL/ASL_Techniques.html" />
    <link rel="prev" title="MRtrix Tutorial #10: Group-Level Analysis" href="MRtrix_10_GroupAnalysis.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Andy's Brain Book
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Install</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation/fsl_mac_install.html">Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Unix for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_Intro.html">什么是Unix系统?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_01_Navigation.html">Unix Tutorial #1: 目录操作</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_02_CopyRemove.html">Unix Tutorial #2: Copying and Removing Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_03_ReadingTextFiles.html">Unix Tutorial #3: Reading Text Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_04_ShellsVariables.html">Unix Tutorial #4: Shells and Path Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_05_ForLoops.html">Unix Tutorial #5: For-Loops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_06_IfElse.html">Unix Tutorial #6: Conditional Statements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_07_Scripting.html">Unix Tutorial #7: Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_08_Sed.html">Unix Tutorial #8: The Sed Command</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_09_AutomatingTheAnalysis.html">Unix Tutorial #9: Automating The Analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">fMRI Short Course with FSL</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_Intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_01_DataDownload.html">fMRI Tutorial #1: Downloading the Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_02_ExperimentalDesign.html">fMRI Tutorial #2: Overview of The Flanker Task</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_03_LookingAtTheData.html">fMRI Tutorial #3: Looking at the Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_04_Preprocessing.html">fMRI Tutorial #4: Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_05_1stLevelAnalysis.html">fMRI Tutorial #5: Statistics and Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_06_Scripting.html">fMRI Tutorial #6: Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_07_2ndLevelAnalysis.html">fMRI Tutorial #7: 2nd-Level Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_08_3rdLevelAnalysis.html">fMRI Tutorial #8: 3rd-Level Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_09_ROIAnalysis.html">fMRI Tutorial #9: ROI Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_10_Summary.html">fMRI Tutorial #10: Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_Appendices.html">fMRI Short Course: Appendices</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FreeSurfer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FreeSurfer/FreeSurfer_Introduction.html">FreeSurfer Short Course</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">E-Prime</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../E-Prime/E-Prime_Overview.html">Overview of E-Prime</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">AFNI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../AFNI/AFNI_Overview.html">AFNI Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SPM</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../SPM/SPM_Overview.html">SPM Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Functional Connectivity with the CONN Toolbox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FunctionalConnectivity/CONN_Overview.html">Functional Connectivity and the CONN Toolbox</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Parametric Modulation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../PM/PM_Overview.html">Parametric Modulation in SPM, FSL, and AFNI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Image Visualization with MRIcroGL</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../MRIcroGL/MRIcroGL_Overview.html">Image Visualization with MRIcroGL</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Introduction to the Human Connectome Project (HCP)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../HCP/HCP_Overview.html">Introduction to the Human Connectome Project</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Finite Impulse Response (FIR) Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FIR/FIR_Overview.html">Finite Impulse Response (FIR)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">fMRI Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Practicals/DesignOptimization.html">Design Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Diffusion Analysis with MRtrix</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../MRtrix_Introduction.html">Introduction to MRtrix</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../MRtrix_Introduction.html#what-is-mrtrix">What is MRtrix?</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../MRtrix_Introduction.html#goals-of-this-course">Goals of This Course</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="MRtrix_00_Diffusion_Overview.html">MRtrix Introduction: Overview of Diffusion Imaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_01_Download_Install.html">MRtrix Tutorial #1: Download and Install</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_02_DataDownload.html">MRtrix Tutorial #2: Downloading the Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_03_DataFormats.html">MRtrix Tutorial #3: Looking at the Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_04_Preprocessing.html">MRtrix Tutorial #4: Preprocessing</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_05_BasisFunctions.html">MRtrix Tutorial #5: Constrained Spherical Deconvolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_06_TissueBoundary.html">MRtrix Tutorial #6: Creating the Tissue Boundaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_07_Streamlines.html">MRtrix Tutorial #7: Streamlines</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_08_Connectome.html">MRtrix Tutorial #8: Creating and Viewing the Connectome</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_09_Scripting.html">MRtrix Tutorial #9: Scripting</a></li>
<li class="toctree-l3"><a class="reference internal" href="MRtrix_10_GroupAnalysis.html">MRtrix Tutorial #10: Group-Level Analysis</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">MRtrix Tutorial #11: Fixel-Based Analysis</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#preparing-the-data-for-fixel-based-analysis">Preparing the Data for Fixel-Based Analysis</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-the-preprocessing-steps">Running the Preprocessing Steps</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-the-glm">Creating The GLM</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fixel-based-analysis-on-the-supercomputing-cluster">Fixel-Based Analysis on the Supercomputing Cluster</a></li>
<li class="toctree-l4"><a class="reference internal" href="#viewing-the-results">Viewing the Results</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ASL Analysis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/ASL_Techniques.html">fASL Tutorial #1: Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/fASL_02_Download.html">fASL Tutorial #2: Downloading and Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/fASL_03_Task.html">fASL Tutorial #3: The N-Back Task</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/04_fASL_GUI.html">fASL Tutorial #4: The GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/05_fASL_Results.html">fASL Tutorial #5: Examining the Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/06_fASL_Quantification.html">fASL Tutorial #6: Quantification</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Frequently Asked Questions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FrequentlyAskedQuestions/FrequentlyAskedQuestions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Statistics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Statistics/GIMME.html">GIMME (Group Iterative Multiple Model Estimation)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Open Science</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../OpenScience/OS_Overview.html">Open Science</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Normalization Tools (ANTs)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ANTs/ANTs_Overview.html">Advanced Normalization Tools (ANTs)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tract-Based Spatial Statistics (TBSS)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../TBSS/TBSS_Overview.html">Introduction to Tract-Based Spatial Statistics (TBSS)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Statistics for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Stats/Stats_Overview.html">Statistics for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Machine Learning for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ML/ML_Overview.html">Machine Learning for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Slicer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Slicer/Slicer_Overview.html">Slicer Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CAT12</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CAT12/CAT12_Overview.html">Voxel-Based Morphometry with CAT12</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using the Supercomputer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Supercomputer/Supercomputer_Overview.html">Introduction to Supercomputing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Matlab for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Matlab/Matlab_Overview.html">Matlab for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ITK-Snap</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ITK-Snap/ITK-Snap_Overview.html">ITK-Snap_Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../PythonForNeuroimagers/PythonForNeuroimagers_Overview.html">Python for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Meta-Analysis for fMRI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../MetaAnalysis/MetaAnalysis_Overview.html">Meta-Analysis for Neuroimagers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Andy's Brain Book</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../MRtrix_Introduction.html">Introduction to MRtrix</a></li>
      <li class="breadcrumb-item active">MRtrix Tutorial #11: Fixel-Based Analysis</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/MRtrix/MRtrix_Course/MRtrix_11_FixelBasedAnalysis.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mrtrix-tutorial-11-fixel-based-analysis">
<span id="mrtrix-11-fixelbasedanalysis"></span><h1>MRtrix Tutorial #11: Fixel-Based Analysis<a class="headerlink" href="#mrtrix-tutorial-11-fixel-based-analysis" title="Link to this heading"></a></h1>
<hr class="docutils" />
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>Until now, we have focused on generating <strong>streamlines</strong>, representations of the underlying white-matter tracts. These are probabilistic tracts, which take into account nearby tissue types and amount of angle in order to create biologically plausible connections between distant cortical regions. MRtrix also allows for the generation of <strong>fixels</strong>, or specific fiber populations within a voxel.</p>
<p>Remember that traditional diffusion-tensor methods cannot resolve the crossing-fibers problem, in which two bundles of fibers crossing at right angles will give the appearance of uniform diffusion within that voxel. By using constrained spherical deconvolution (CSD) with a single fiber orientation as a basis function, we can resolve the signal measured within a voxel into its constituent fibers, or fiber orientation distributions (FODs). This can then be used to quantify the fiber density (FD) of the underlying white matter, as well as changes to the overall size of the cross-section within a given voxel (fiber cross-section, or FC). These two metrics can furthermore be combined into a single metric called fiber density and cross-section (FDC).</p>
<p><a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S1053811916304943#f0015">Raffelt et al., 2015</a>, illustrated the difference in these metrics by using an example 7x7 matrix of voxels. Given a certain amount of white matter fibers within the voxels, a reduction in the number of fibers can happen in three different ways:</p>
<ol class="arabic simple">
<li><p>The amount of white matter fibers occupies the same number of voxels, but the overall density decerases (reduced FD); or</p></li>
<li><p>The density stays the same, buy the white matter fibes occupy fewer voxels (reduced FC); or</p></li>
<li><p>Both the number of occupied voxels and the density of white matter within those voxels decrease (reduced FDC).</p></li>
</ol>
<p>The opposite of each of these scenarios could also take place, which would lead to increases in each of those metrics, respectively.</p>
<figure class="align-default" id="id1">
<img alt="../../_images/11_Raffelt_2017_Fig1.jpg" src="../../_images/11_Raffelt_2017_Fig1.jpg" />
<figcaption>
<p><span class="caption-text">Figure 1 from Raffelt et al., 2017</span><a class="headerlink" href="#id1" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="preparing-the-data-for-fixel-based-analysis">
<h2>Preparing the Data for Fixel-Based Analysis<a class="headerlink" href="#preparing-the-data-for-fixel-based-analysis" title="Link to this heading"></a></h2>
<p>Some of the steps for doing a Fixel-Based Analysis are similar to what was done in the previous chapters of this module. There are some significant differences, however, once the Fiber Orientations are estimated and then warped to a template.</p>
<p>If you are analyzing a large number of subjects - for example, several dozen or more - you will either need a computer with at least a couple of hundred gigabytes of memory, and ideally multiple processors. Fixel-based analysis can be done on a local machine, but it can take a long time; several days, depending on how many subjects you have. Regardless, you can process these images by using MRtrix’s <code class="docutils literal notranslate"><span class="pre">for_each</span></code> command (details about the command can be found <a class="reference external" href="https://mrtrix.readthedocs.io/en/dev/reference/commands/for_each.html">here</a>). To illustrate how to use this batch command, we will take a relatively simple case of denoising the raw diffusion-weighted data.</p>
<p>To begin, we will organize our data so that each subject folder contains converted raw data called <code class="docutils literal notranslate"><span class="pre">dwi.mif</span></code>. For example, if we have three subjects from the BTC_Preop dataset, we can create a new sub-folder called <code class="docutils literal notranslate"><span class="pre">Fixel_Analysis</span></code>. Within that folder, create another folder called <code class="docutils literal notranslate"><span class="pre">subjects</span></code>, which contains three sub-folders, <code class="docutils literal notranslate"><span class="pre">sub-01</span></code>, <code class="docutils literal notranslate"><span class="pre">sub-02</span></code>, and <code class="docutils literal notranslate"><span class="pre">sub-03</span></code>. Assuming that each of these folders contain each subject’s corresponding raw diffusion data and bvals and bvecs files, you can convert them by typing the following code from the <code class="docutils literal notranslate"><span class="pre">subjects</span></code> folder:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">-</span><span class="mi">01</span> <span class="n">sub</span><span class="o">-</span><span class="mi">02</span> <span class="n">sub</span><span class="o">-</span><span class="mi">03</span><span class="p">;</span> <span class="n">do</span>
  <span class="n">mrconvert</span> <span class="o">*.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">dwi</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">fslgrad</span> <span class="o">*.</span><span class="n">bvec</span> <span class="o">*</span><span class="n">bval</span>
  <span class="n">rm</span> <span class="o">*.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span>
<span class="n">done</span>
</pre></div>
</div>
<p>This will create a new raw diffusion-weighted image, which contains the b-vectors and b-values in its header.</p>
<p>The next preprocessing steps can be found on <a class="reference external" href="https://mrtrix.readthedocs.io/en/latest/fixel_based_analysis/mt_fibre_density_cross-section.html">this webpage</a>, on the MRtrix website. They explain each of the steps in detail, so we will not repeat all of the explanations here. Let us instead focus on the first preprocessing step, denoising, to illustrate how the <code class="docutils literal notranslate"><span class="pre">for_each</span></code> command works. For example, if we run the following code from the <code class="docutils literal notranslate"><span class="pre">subjects</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">dwidenoise</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi</span><span class="o">.</span><span class="n">mif</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_denoised</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<p>The code to the left of the colon (<code class="docutils literal notranslate"><span class="pre">:</span></code>) means to loop over every item captured by the <code class="docutils literal notranslate"><span class="pre">*</span></code> wildcard. (Note that if there are any other files besides the subject folders in this directory, such as text files, that the command will throw an error, since it is trying to applyg a preprocessing step to a non-diffusion file.) Each of the items are loaded into the <code class="docutils literal notranslate"><span class="pre">IN</span></code> keyword; for the first subject, for example, this will expand to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dwidenoise</span> <span class="n">sub</span><span class="o">-</span><span class="mi">01</span><span class="o">/</span><span class="n">dwi</span><span class="o">.</span><span class="n">mif</span> <span class="n">sub</span><span class="o">-</span><span class="mi">01</span><span class="o">/</span><span class="n">dwi_denoised</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<p>Which takes sub-01’s dwi.mif file, denoises it, and places the output file, <code class="docutils literal notranslate"><span class="pre">dwi_denoised.mif</span></code>, in the sub-01 folder. This is the same procedure that is used for all of the other <code class="docutils literal notranslate"><span class="pre">for_each</span></code> commands listed in the tutorial. One variation that you should be aware of is the <code class="docutils literal notranslate"><span class="pre">PRE</span></code> keyword, which is the input item stripped of its extension.</p>
</section>
<section id="running-the-preprocessing-steps">
<h2>Running the Preprocessing Steps<a class="headerlink" href="#running-the-preprocessing-steps" title="Link to this heading"></a></h2>
<p>You can either adapt the commands from the MRtrix tutorial to you data structure, or, assuming that you have the subjects organized with a single <code class="docutils literal notranslate"><span class="pre">dwi.mif</span></code> file in each folder, you can copy and paste the following code below (note that this omits bias field correction, which, in my experience, can sometimes results in worse brain mask estimation later on):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">dwidenoise</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi</span><span class="o">.</span><span class="n">mif</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_denoised</span><span class="o">.</span><span class="n">mif</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">mrdegibbs</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_denoised</span><span class="o">.</span><span class="n">mif</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_denoised_unringed</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">axes</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">dwifslpreproc</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_denoised_unringed</span><span class="o">.</span><span class="n">mif</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_denoised_unringed_preproc</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">rpe_none</span> <span class="o">-</span><span class="n">pe_dir</span> <span class="n">AP</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">dwi2response</span> <span class="n">dhollander</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_denoised_unringed_preproc</span><span class="o">.</span><span class="n">mif</span> <span class="n">IN</span><span class="o">/</span><span class="n">response_wm</span><span class="o">.</span><span class="n">txt</span> <span class="n">IN</span><span class="o">/</span><span class="n">response_gm</span><span class="o">.</span><span class="n">txt</span> <span class="n">IN</span><span class="o">/</span><span class="n">response_csf</span><span class="o">.</span><span class="n">txt</span>
<span class="n">responsemean</span> <span class="o">*/</span><span class="n">response_wm</span><span class="o">.</span><span class="n">txt</span> <span class="o">../</span><span class="n">group_average_response_wm</span><span class="o">.</span><span class="n">txt</span>
<span class="n">responsemean</span> <span class="o">*/</span><span class="n">response_gm</span><span class="o">.</span><span class="n">txt</span> <span class="o">../</span><span class="n">group_average_response_gm</span><span class="o">.</span><span class="n">txt</span>
<span class="n">responsemean</span> <span class="o">*/</span><span class="n">response_csf</span><span class="o">.</span><span class="n">txt</span> <span class="o">../</span><span class="n">group_average_response_csf</span><span class="o">.</span><span class="n">txt</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">mrgrid</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_denoised_unringed_preproc_unbiased</span><span class="o">.</span><span class="n">mif</span> <span class="n">regrid</span> <span class="o">-</span><span class="n">vox</span> <span class="mf">1.25</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_denoised_unringed_preproc_unbiased_upsampled</span><span class="o">.</span><span class="n">mif</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">dwi2mask</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_denoised_unringed_preproc_unbiased_upsampled</span><span class="o">.</span><span class="n">mif</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_mask_upsampled</span><span class="o">.</span><span class="n">mif</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">dwi2fod</span> <span class="n">msmt_csd</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_denoised_unringed_preproc_unbiased_upsampled</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">group_average_response_wm</span><span class="o">.</span><span class="n">txt</span> <span class="n">IN</span><span class="o">/</span><span class="n">wmfod</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">group_average_response_gm</span><span class="o">.</span><span class="n">txt</span> <span class="n">IN</span><span class="o">/</span><span class="n">gm</span><span class="o">.</span><span class="n">mif</span>  <span class="o">../</span><span class="n">group_average_response_csf</span><span class="o">.</span><span class="n">txt</span> <span class="n">IN</span><span class="o">/</span><span class="n">csf</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">mask</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_mask_upsampled</span><span class="o">.</span><span class="n">mif</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">mtnormalise</span> <span class="n">IN</span><span class="o">/</span><span class="n">wmfod</span><span class="o">.</span><span class="n">mif</span> <span class="n">IN</span><span class="o">/</span><span class="n">wmfod_norm</span><span class="o">.</span><span class="n">mif</span> <span class="n">IN</span><span class="o">/</span><span class="n">gm</span><span class="o">.</span><span class="n">mif</span> <span class="n">IN</span><span class="o">/</span><span class="n">gm_norm</span><span class="o">.</span><span class="n">mif</span> <span class="n">IN</span><span class="o">/</span><span class="n">csf</span><span class="o">.</span><span class="n">mif</span> <span class="n">IN</span><span class="o">/</span><span class="n">csf_norm</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">mask</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_mask_upsampled</span><span class="o">.</span><span class="n">mif</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fod_input</span>
<span class="n">mkdir</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">mask_input</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">ln</span> <span class="o">-</span><span class="n">sr</span> <span class="n">IN</span><span class="o">/</span><span class="n">wmfod_norm</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fod_input</span><span class="o">/</span><span class="n">PRE</span><span class="o">.</span><span class="n">mif</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">ln</span> <span class="o">-</span><span class="n">sr</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_mask_upsampled</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">mask_input</span><span class="o">/</span><span class="n">PRE</span><span class="o">.</span><span class="n">mif</span>
<span class="n">population_te</span> <span class="n">mplate</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fod_input</span> <span class="o">-</span><span class="n">mask_dir</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">mask_input</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">wmfod_template</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">voxel_size</span> <span class="mf">1.25</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">mrregister</span> <span class="n">IN</span><span class="o">/</span><span class="n">wmfod_norm</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">mask1</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_mask_upsampled</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">wmfod_template</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">nl_warp</span> <span class="n">IN</span><span class="o">/</span><span class="n">subject2template_warp</span><span class="o">.</span><span class="n">mif</span> <span class="n">IN</span><span class="o">/</span><span class="n">template2subject_warp</span><span class="o">.</span><span class="n">mif</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">mrtransform</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_mask_upsampled</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">warp</span> <span class="n">IN</span><span class="o">/</span><span class="n">subject2template_warp</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">interp</span> <span class="n">nearest</span> <span class="o">-</span><span class="n">datatype</span> <span class="n">bit</span> <span class="n">IN</span><span class="o">/</span><span class="n">dwi_mask_in_template_space</span><span class="o">.</span><span class="n">mif</span>
<span class="n">mrmath</span> <span class="o">*/</span><span class="n">dwi_mask_in_template_space</span><span class="o">.</span><span class="n">mif</span> <span class="nb">min</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">template_mask</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">datatype</span> <span class="n">bit</span>
<span class="n">fod2fixel</span> <span class="o">-</span><span class="n">mask</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">template_mask</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">fmls_peak_value</span> <span class="mf">0.06</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">wmfod_template</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fixel_mask</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">mrtransform</span> <span class="n">IN</span><span class="o">/</span><span class="n">wmfod_norm</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">warp</span> <span class="n">IN</span><span class="o">/</span><span class="n">subject2template_warp</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">reorient_fod</span> <span class="n">no</span> <span class="n">IN</span><span class="o">/</span><span class="n">fod_in_template_space_NOT_REORIENTED</span><span class="o">.</span><span class="n">mif</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">fod2fixel</span> <span class="o">-</span><span class="n">mask</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">template_mask</span><span class="o">.</span><span class="n">mif</span> <span class="n">IN</span><span class="o">/</span><span class="n">fod_in_template_space_NOT_REORIENTED</span><span class="o">.</span><span class="n">mif</span> <span class="n">IN</span><span class="o">/</span><span class="n">fixel_in_template_space_NOT_REORIENTED</span> <span class="o">-</span><span class="n">afd</span> <span class="n">fd</span><span class="o">.</span><span class="n">mif</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">fixelreorient</span> <span class="n">IN</span><span class="o">/</span><span class="n">fixel_in_template_space_NOT_REORIENTED</span> <span class="n">IN</span><span class="o">/</span><span class="n">subject2template_warp</span><span class="o">.</span><span class="n">mif</span> <span class="n">IN</span><span class="o">/</span><span class="n">fixel_in_template_space</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">fixelcorrespondence</span> <span class="n">IN</span><span class="o">/</span><span class="n">fixel_in_template_space</span><span class="o">/</span><span class="n">fd</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fixel_mask</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fd</span> <span class="n">PRE</span><span class="o">.</span><span class="n">mif</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">warp2metric</span> <span class="n">IN</span><span class="o">/</span><span class="n">subject2template_warp</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">fc</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fixel_mask</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fc</span> <span class="n">IN</span><span class="o">.</span><span class="n">mif</span>
<span class="n">mkdir</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">log_fc</span>
<span class="n">cp</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fc</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fc</span><span class="o">/</span><span class="n">directions</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">log_fc</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">mrcalc</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fc</span><span class="o">/</span><span class="n">IN</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">log</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">log_fc</span><span class="o">/</span><span class="n">IN</span><span class="o">.</span><span class="n">mif</span>
<span class="n">mkdir</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fdc</span>
<span class="n">cp</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fc</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fdc</span>
<span class="n">cp</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fc</span><span class="o">/</span><span class="n">directions</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fdc</span>
<span class="n">for_each</span> <span class="o">*</span> <span class="p">:</span> <span class="n">mrcalc</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fd</span><span class="o">/</span><span class="n">IN</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fc</span><span class="o">/</span><span class="n">IN</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">mult</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fdc</span><span class="o">/</span><span class="n">IN</span><span class="o">.</span><span class="n">mif</span>
<span class="n">cd</span> <span class="o">../</span><span class="n">template</span>
<span class="n">tckgen</span> <span class="o">-</span><span class="n">angle</span> <span class="mf">22.5</span> <span class="o">-</span><span class="n">maxlen</span> <span class="mi">250</span> <span class="o">-</span><span class="n">minlen</span> <span class="mi">10</span> <span class="o">-</span><span class="n">power</span> <span class="mf">1.0</span> <span class="n">wmfod_template</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">seed_image</span> <span class="n">template_mask</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">mask</span> <span class="n">template_mask</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">select</span> <span class="mi">20000000</span> <span class="o">-</span><span class="n">cutoff</span> <span class="mf">0.06</span> <span class="n">tracks_20_million</span><span class="o">.</span><span class="n">tck</span>
<span class="n">tcksift</span> <span class="n">tracks_20_million</span><span class="o">.</span><span class="n">tck</span> <span class="n">wmfod_template</span><span class="o">.</span><span class="n">mif</span> <span class="n">tracks_2_million_sift</span><span class="o">.</span><span class="n">tck</span> <span class="o">-</span><span class="n">term_number</span> <span class="mi">2000000</span>
<span class="n">fixelconnectivity</span> <span class="n">fixel_mask</span><span class="o">/</span> <span class="n">tracks_2_million_sift</span><span class="o">.</span><span class="n">tck</span> <span class="n">matrix</span><span class="o">/</span>
<span class="n">fixelfilter</span> <span class="n">fd</span> <span class="n">smooth</span> <span class="n">fd_smooth</span> <span class="o">-</span><span class="n">matrix</span> <span class="n">matrix</span><span class="o">/</span>
<span class="n">fixelfilter</span> <span class="n">log_fc</span> <span class="n">smooth</span> <span class="n">log_fc_smooth</span> <span class="o">-</span><span class="n">matrix</span> <span class="n">matrix</span><span class="o">/</span>
<span class="n">fixelfilter</span> <span class="n">fdc</span> <span class="n">smooth</span> <span class="n">fdc_smooth</span> <span class="o">-</span><span class="n">matrix</span> <span class="n">matrix</span><span class="o">/</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Sometimes the command <code class="docutils literal notranslate"><span class="pre">dwi2mask</span></code> may fail to cover the entire brain, especially pockets of cerebrospinal fluid. In that case, you can replace the <code class="docutils literal notranslate"><span class="pre">dwi2mask</span></code> command with FSL’s <code class="docutils literal notranslate"><span class="pre">bet2</span></code> command, which will require converting the mask to NIFTI format and then back to .mif format:</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On Macintosh operating systems, the command <code class="docutils literal notranslate"><span class="pre">ln</span> <span class="pre">-sr</span></code> may not work (it should work on most Linux systems). In that case, copy the <code class="docutils literal notranslate"><span class="pre">wmfod*.mif</span></code> files into the <code class="docutils literal notranslate"><span class="pre">template/fod_input</span></code> folder, and copy the files <code class="docutils literal notranslate"><span class="pre">dwi_mask_upsampled*.mif</span></code> into the <code class="docutils literal notranslate"><span class="pre">template/mask_input</span></code> folder. You may have to give each of the files a unique subject ID.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mrconvert</span> <span class="o">-</span><span class="n">force</span> <span class="n">dwi_denoised_unringed_preproc_upsampled</span><span class="o">.</span><span class="n">mif</span> <span class="n">tmp</span><span class="o">.</span><span class="n">nii</span>
<span class="n">bet2</span> <span class="n">tmp</span><span class="o">.</span><span class="n">nii</span> <span class="n">tmp</span> <span class="o">-</span><span class="n">m</span> <span class="o">-</span><span class="n">f</span> <span class="mf">0.2</span>
<span class="n">mrconvert</span> <span class="o">-</span><span class="n">force</span> <span class="n">tmp_mask</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">dwi_mask_upsampled</span><span class="o">.</span><span class="n">mif</span>
<span class="n">rm</span> <span class="n">tmp</span><span class="o">*</span>
</pre></div>
</div>
<p>Make sure to check the mask as we did in the previous tutorials of this walkthrough, to ensure that there are no holes in the mask. You may have to change the value after the -f option to generate a good whole-brain mask that covers all of the voxels of the brain. Using this approach may resolve any “balance factor” errors with <code class="docutils literal notranslate"><span class="pre">mtnormalise</span></code>, especially if one or more of the tissue types is empty.</p>
</div>
</section>
<section id="creating-the-glm">
<h2>Creating The GLM<a class="headerlink" href="#creating-the-glm" title="Link to this heading"></a></h2>
<blockquote>
<div><p>The last few steps in the tutorial require a design matrix and a contrast matrix, similar to those that are created with FSL (for examples, see <a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/GLM">this page</a>). For a simple effect averaged across all of the participants Fixel-based metrics, we would create a column of all 1’s, such as the following:</p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span>
<span class="mi">1</span>
<span class="mi">1</span>
</pre></div>
</div>
<p>And save it into a file called <code class="docutils literal notranslate"><span class="pre">design_matrix.txt</span></code> (or whatever label you find most useful). We would also create an accompanying contrast matrix, which would just contain:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span>
</pre></div>
</div>
<p>And save it into a file called <code class="docutils literal notranslate"><span class="pre">contrast_matrix.txt</span></code>, in this example. The above text files specify that we are weighting all of the subjects equally, and giving them a contrast value of 1 to average across all of their values for each fixel. We can then run these simple effect analyses on each of the fixel-based metrics - FD, FC, and FDC:</p>
<blockquote>
<div><p>fixelcfestats fd_smooth/ files.txt design_matrix.txt contrast_matrix.txt matrix/ stats_fd/
fixelcfestats log_fc_smooth/ files.txt design_matrix.txt contrast_matrix.txt matrix/ stats_log_fc/
fixelcfestats fdc_smooth/ files.txt design_matrix.txt contrast_matrix.txt matrix/ stats_fdc/</p>
</div></blockquote>
<p>This will generate each metric’s corresponding stats folder, with each one containing files that represent different statistics. For example, we can load the file <code class="docutils literal notranslate"><span class="pre">wmfod_template.mif</span></code> in mrview as an underlay, and then click on <code class="docutils literal notranslate"><span class="pre">Tool</span> <span class="pre">-&gt;</span> <span class="pre">Fixel</span> <span class="pre">plot</span></code>; to load, for example, the <code class="docutils literal notranslate"><span class="pre">Zstat.mif</span></code> file, click on the folder icron at the top of the Fixel plot panel, navigate to <code class="docutils literal notranslate"><span class="pre">stats_fdc</span></code>, and select the file <code class="docutils literal notranslate"><span class="pre">Zstat.mif</span></code>. You should see something like this:</p>
<figure class="align-default">
<img alt="../../_images/11_Zstat_FDC_Example.png" src="../../_images/11_Zstat_FDC_Example.png" />
</figure>
<p>By default, there will be a colorscale bar in the viewing panel showing the minimum and maximum Z-statistic in this image; in our case, the maximum Z-statistic is 5.33, indicating the highest Z-statistic for the FDC values. If we zoom into a region such as the left superior longitudinal fasciculus, we can see each fixel composed of three orthogonal directions, changing in orientation as we move along the different fiber bundles, and each vector of the fixel color-coded by its strength:</p>
<figure class="align-default">
<img alt="../../_images/11_FDC_Directions.png" src="../../_images/11_FDC_Directions.png" />
</figure>
<p>You can also load the file <code class="docutils literal notranslate"><span class="pre">fwe_1mpvalue.mif</span></code>, which will show a 1-p map of significant fixels, which can be thresholded at 0.95 to show only those fixels that pass a significance threshold of p=0.05. Given that we only have three subjects, it’s unlikely that we have any significant fixels, and they wouldn’t mean much for a simple effects analysis in any case. To look at contrasts between groups, on the other hand, we will analyze the entire dataset on a computing cluster, such as the University of Michigan’s Great Lakes supercomputer.</p>
</section>
<section id="fixel-based-analysis-on-the-supercomputing-cluster">
<h2>Fixel-Based Analysis on the Supercomputing Cluster<a class="headerlink" href="#fixel-based-analysis-on-the-supercomputing-cluster" title="Link to this heading"></a></h2>
<p>For larger numbers of subjects - such as the entire BTC_Preop dataset - we can use a supercomputing cluster to save both time and storage space on our local machines. In this example, I am using my account on Great Lakes, and I will be using my space on the <code class="docutils literal notranslate"><span class="pre">turbo</span></code> folder. First, we will download the dataset using the <code class="docutils literal notranslate"><span class="pre">aws</span></code> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">turbo</span><span class="o">/</span><span class="n">lsa</span><span class="o">-</span><span class="n">ajahn</span>
<span class="n">aws</span> <span class="n">s3</span> <span class="n">sync</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">sign</span><span class="o">-</span><span class="n">request</span> <span class="n">s3</span><span class="p">:</span><span class="o">//</span><span class="n">openneuro</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">ds001226</span> <span class="n">ds001226</span><span class="o">-</span><span class="n">download</span><span class="o">/</span>
<span class="n">mv</span> <span class="n">ds001226</span><span class="o">-</span><span class="n">download</span> <span class="n">BTC_Preop</span>
</pre></div>
</div>
<p>We will also create a template batch script, which has the following SBATCH setup lines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1">#SBATCH --job-name=FBA_Template_changeme</span>
<span class="c1">#SBATCH --time=24:00:00</span>

<span class="c1">#SBATCH --nodes=1</span>
<span class="c1">#SBATCH --ntasks-per-node=1</span>
<span class="c1">#SBATCH --cpus-per-task=1</span>
<span class="c1">#SBATCH --mem=8gb</span>

<span class="c1">#SBATCH --account=ajahn0</span>
<span class="c1">#SBATCH --partition=standard</span>

<span class="c1">#SBATCH --mail-type=NONE</span>
</pre></div>
</div>
<p>Many of these parameters are covered in more detail in Bennet Fauber’s Supercomputing Tutorial, which can be found <a class="reference external" href="https://justbennet.github.io/umich-cluster-neuroimaging/">here</a>. For now, note that we are using the <code class="docutils literal notranslate"><span class="pre">standard</span></code> partition, we are allocating 24 hours for this script to run, and that we will use 8gb per job that we submit. (Using too little memory can lead to errors during commands such as <code class="docutils literal notranslate"><span class="pre">dwi2mask</span></code>.) The <code class="docutils literal notranslate"><span class="pre">--account</span></code> field will need to be changed to your account when you run the script.</p>
<p>The next few lines of code will load the modules needed for MRtrix, as well as a line of code that will be change in a for-loop:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">load</span> <span class="n">mrtrix</span> <span class="n">fsl</span>
<span class="n">my_job_header</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">turbo</span><span class="o">/</span><span class="n">lsa</span><span class="o">-</span><span class="n">ajahn</span><span class="o">/</span><span class="n">BTC_Preop</span><span class="o">/</span><span class="n">changeme</span>
</pre></div>
</div>
<p>The last string, <code class="docutils literal notranslate"><span class="pre">changeme</span></code>, will be replaced by a <code class="docutils literal notranslate"><span class="pre">sed</span></code> command. For example, we can create another auxiliary script, <code class="docutils literal notranslate"><span class="pre">submitPreprocJobs.sh</span></code>, which contains the following code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

for i in `cat subjList.txt`; do sed &quot;s|changeme|${i}|g&quot; runDWIPreproc.sbat &gt; tmp_${i}.sbat; done
for i in `cat subjList.txt`; do sbatch tmp_${i}.sbat; done
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">subjList.txt</span></code> is a list of all of the subject folders used in this experiment; you can create it by typing <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">^sub-</span> <span class="pre">&gt;</span> <span class="pre">subjList.txt</span></code>.</p>
<p>Returning to our preprocessing script, the complete file should look something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1">#SBATCH --job-name=FBA_Template_changeme</span>
<span class="c1">#SBATCH --time=24:00:00</span>

<span class="c1">#SBATCH --nodes=1</span>
<span class="c1">#SBATCH --ntasks-per-node=1</span>
<span class="c1">#SBATCH --cpus-per-task=1</span>
<span class="c1">#SBATCH --mem=8gb</span>

<span class="c1">#SBATCH --account=ajahn0</span>
<span class="c1">#SBATCH --partition=standard</span>

<span class="c1">#SBATCH --mail-type=NONE</span>

<span class="c1">#----------------------</span>
<span class="c1"># Load modules</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">mrtrix</span> <span class="n">fsl</span> <span class="n">cuda</span><span class="o">/</span><span class="mf">10.2.89</span>

<span class="c1">#----------------------</span>
<span class="c1"># Print diagnostic informatino to the job output file</span>
<span class="n">my_job_header</span>

<span class="c1">#----------------------</span>
<span class="c1"># Commands to run during job</span>

<span class="n">cd</span> <span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">turbo</span><span class="o">/</span><span class="n">lsa</span><span class="o">-</span><span class="n">ajahn</span><span class="o">/</span><span class="n">BTC_Preop</span><span class="o">/</span><span class="n">changeme</span>
<span class="n">dwidenoise</span> <span class="o">-</span><span class="n">force</span> <span class="n">dwi</span><span class="o">.</span><span class="n">mif</span> <span class="n">dwi_denoised</span><span class="o">.</span><span class="n">mif</span>
<span class="n">mrdegibbs</span> <span class="o">-</span><span class="n">force</span> <span class="n">dwi_denoised</span><span class="o">.</span><span class="n">mif</span> <span class="n">dwi_denoised_unringed</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">axes</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span>
<span class="n">dwifslpreproc</span> <span class="o">-</span><span class="n">force</span> <span class="n">dwi_denoised_unringed</span><span class="o">.</span><span class="n">mif</span> <span class="n">dwi_denoised_unringed_preproc</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">rpe_none</span> <span class="o">-</span><span class="n">pe_dir</span> <span class="n">AP</span>
<span class="n">dwi2response</span> <span class="o">-</span><span class="n">force</span> <span class="n">dhollander</span> <span class="n">dwi_denoised_unringed_preproc</span><span class="o">.</span><span class="n">mif</span> <span class="n">response_wm</span><span class="o">.</span><span class="n">txt</span> <span class="n">response_gm</span><span class="o">.</span><span class="n">txt</span> <span class="n">response_csf</span><span class="o">.</span><span class="n">txt</span>
<span class="n">mrgrid</span> <span class="o">-</span><span class="n">force</span> <span class="n">dwi_denoised_unringed_preproc</span><span class="o">.</span><span class="n">mif</span> <span class="n">regrid</span> <span class="o">-</span><span class="n">vox</span> <span class="mf">1.25</span> <span class="n">dwi_denoised_unringed_preproc_upsampled</span><span class="o">.</span><span class="n">mif</span>
<span class="n">mrconvert</span> <span class="o">-</span><span class="n">force</span> <span class="n">dwi_denoised_unringed_preproc_upsampled</span><span class="o">.</span><span class="n">mif</span> <span class="n">tmp</span><span class="o">.</span><span class="n">nii</span>
<span class="n">bet2</span> <span class="n">tmp</span><span class="o">.</span><span class="n">nii</span> <span class="n">tmp</span> <span class="o">-</span><span class="n">m</span> <span class="o">-</span><span class="n">f</span> <span class="mf">0.2</span>
<span class="n">mrconvert</span> <span class="o">-</span><span class="n">force</span> <span class="n">tmp_mask</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span> <span class="n">dwi_mask_upsampled</span><span class="o">.</span><span class="n">mif</span>
<span class="n">dwi2mask</span> <span class="o">-</span><span class="n">force</span> <span class="n">dwi_denoised_unringed_preproc_upsampled</span><span class="o">.</span><span class="n">mif</span> <span class="n">dwi_mask_upsampled</span><span class="o">.</span><span class="n">mif</span>
<span class="n">dwi2fod</span> <span class="o">-</span><span class="n">force</span> <span class="n">msmt_csd</span> <span class="n">dwi_denoised_unringed_preproc_upsampled</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">group_average_response_wm</span><span class="o">.</span><span class="n">txt</span> <span class="n">wmfod</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">group_average_response_gm</span><span class="o">.</span><span class="n">txt</span> <span class="n">gm</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">group_average_response_csf</span><span class="o">.</span><span class="n">txt</span> <span class="n">csf</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">mask</span> <span class="n">dwi_mask_upsampled</span><span class="o">.</span><span class="n">mif</span>
<span class="n">mtnormalise</span> <span class="o">-</span><span class="n">force</span> <span class="n">wmfod</span><span class="o">.</span><span class="n">mif</span> <span class="n">wmfod_norm</span><span class="o">.</span><span class="n">mif</span> <span class="n">csf</span><span class="o">.</span><span class="n">mif</span> <span class="n">csf_norm</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">mask</span> <span class="n">dwi_mask_upsampled</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<p>Save this file as <code class="docutils literal notranslate"><span class="pre">runDWIPreproc.sbat</span></code>. Then, create all of the individual <code class="docutils literal notranslate"><span class="pre">.sbat</span></code> files and submit them by typing <code class="docutils literal notranslate"><span class="pre">bash</span> <span class="pre">submitPreprocJobs.sh</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At this point, you should use <code class="docutils literal notranslate"><span class="pre">mrview</span></code> to check the results of these preprocessing steps. <code class="docutils literal notranslate"><span class="pre">mrview</span></code> does not work on the University of Michigan’s Great Lakes computing cluster, so you will either need to download the data to your local machine that has <code class="docutils literal notranslate"><span class="pre">mrview</span></code>, or instead you can <strong>mount</strong> Turbo directly onto your local machine. This allows you to look at the data without having to download it. To moutn Turbo, follow the instrucions located <a class="reference external" href="https://arc.umich.edu/document/mounting-your-turbo-volume/">here</a>. In my case, I opened a new Finder window on my Macintosh machine, and in the server address field I typed <code class="docutils literal notranslate"><span class="pre">smb://lsa-ajahn-win.turbo.storage.umich.edu/lsa-ajahn</span></code>, which created a new directory on my local machine called <code class="docutils literal notranslate"><span class="pre">/Volumes/lsa-ajahn</span></code>.</p>
</div>
<p>At this point, we will run a separate batch script, <code class="docutils literal notranslate"><span class="pre">runPopulationTemplate.sbat</span></code>, which will create a study-specific template on which we will visualize our results. This step can take a significant amount of time, so we will increase the time limit to 300 hours:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

#----------------------------
# Slurm variables

#SBATCH --job-name=runDWIPreproc_changeme
#SBATCH --time=300:00:00

#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=1
#SBATCH --mem=8gb

#SBATCH --account=fmrilab_project1
#SBATCH --partition=standard

#SBATCH --mail-type=NONE

#-----------------------------
# Load modules
module load mrtrix fsl cuda/10.2.89

#-----------------------------
# Print diagnostic information to the job output file
my_job_header

#-----------------------------
# Commands to run during job

cd /nfs/turbo/lsa-ajahn/BTC_Preop/

mkdir -p template/fod_input
mkdir template/mask_input

for_each `ls | grep ^sub-CON` : ln -sr IN/wmfod_norm.mif template/fod_input/PRE.mif
for_each `ls | grep ^sub-PAT | head -11` : ln -sr IN/wmfod_norm.mif template/fod_input/PRE.mif
for_each `ls | grep ^sub-CON` : ln -sr IN/dwi_mask_upsampled.mif template/mask_input/PRE.mif
for_each `ls | grep ^sub-PAT | head -11` : ln -sr IN/dwi_mask_upsampled.mif template/mask_input/PRE.mif

population_template template/fod_input -mask_dir template/mask_input/ template/wmfod_template.mif -voxel_size 1.25
</pre></div>
</div>
<p>Note that in this example we have chosen to include all 11 Control subjects, and 11 subjects from the Patient group. This is done both to balance the number of subjects from each group that are used to create the template, and also to save processing time.</p>
<p>When that step has finished (which may take several days), run the next section of code, <code class="docutils literal notranslate"><span class="pre">runDWIPreproc_Phase2.sbat</span></code>, by saving the following script into your <code class="docutils literal notranslate"><span class="pre">BTC_Preop</span></code> directory that contains all of the subjects:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1">#----------------------------</span>
<span class="c1"># Slurm variables</span>

<span class="c1">#SBATCH --job-name=runDWIPreproc_changeme</span>
<span class="c1">#SBATCH --time=2:00:00</span>

<span class="c1">#SBATCH --nodes=1</span>
<span class="c1">#SBATCH --ntasks-per-node=1</span>
<span class="c1">#SBATCH --cpus-per-task=1</span>
<span class="c1">#SBATCH --mem=8gb</span>

<span class="c1">#SBATCH --account=fmrilab_project1</span>
<span class="c1">#SBATCH --partition=standard</span>

<span class="c1">#SBATCH --mail-type=NONE</span>

<span class="c1">#-----------------------------</span>
<span class="c1"># Load modules</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">mrtrix</span> <span class="n">fsl</span> <span class="n">cuda</span><span class="o">/</span><span class="mf">10.2.89</span>

<span class="c1">#-----------------------------</span>
<span class="c1"># Print diagnostic information to the job output file</span>
<span class="n">my_job_header</span>

<span class="c1">#-----------------------------</span>
<span class="c1"># Commands to run during job</span>

<span class="n">cd</span> <span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">turbo</span><span class="o">/</span><span class="n">lsa</span><span class="o">-</span><span class="n">ajahn</span><span class="o">/</span><span class="n">BTC_Preop</span><span class="o">/</span><span class="n">changeme</span>
<span class="c1">#mtnormalise -force wmfod.mif wmfod_norm.mif csf.mif csf_norm.mif -mask dwi_mask_upsampled.mif</span>
<span class="n">mrregister</span> <span class="n">wmfod_norm</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">mask1</span> <span class="n">dwi_mask_upsampled</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">wmfod_template</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">nl_warp</span> <span class="n">subject2template_warp</span><span class="o">.</span><span class="n">mif</span> <span class="n">template2subject_warp</span><span class="o">.</span><span class="n">mif</span>
<span class="n">mrtransform</span> <span class="n">dwi_mask_upsampled</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">warp</span> <span class="n">subject2template_warp</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">interp</span> <span class="n">nearest</span> <span class="o">-</span><span class="n">datatype</span> <span class="n">bit</span> <span class="n">dwi_mask_in_template_space</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<p>And then submit the scripts with the following code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for i in `cat subjList.txt`; do sed &quot;s|changeme|${i}|g&quot; runDWIPreproc_Phase2.sbat &gt; tmp_${i}.sbat; done
for i in `cat subjList.txt`; do sbatch tmp_${i}.sbat; done
</pre></div>
</div>
<p>This will register each subject’s FOD image to the FOD template created above, and then warp those masks to template space. We will also need to take the intersection of all the warped masks with <code class="docutils literal notranslate"><span class="pre">mrmath</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mrmath</span> <span class="n">sub</span><span class="o">-*/</span><span class="n">dwi_mask_in_template_space</span><span class="o">.</span><span class="n">mif</span> <span class="nb">min</span> <span class="n">template</span><span class="o">/</span><span class="n">template_mask</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">datatype</span> <span class="n">bit</span>
</pre></div>
</div>
<p>You should then look at the overall intersected mask with mrview by typing <code class="docutils literal notranslate"><span class="pre">mrview</span> <span class="pre">template/template_mask.mif</span></code>:</p>
<figure class="align-default" id="id2">
<img alt="MRtrix/MRtrix_Course/11_Check_Masks.png" src="MRtrix/MRtrix_Course/11_Check_Masks.png" />
<figcaption>
<p><span class="caption-text">Intersection mask for this study. Mask sure there are no holes or gaps in the masks, and visualize the orthogonal slices by clicking on the View dropdown menu and selecting Ortho View. According to the MRtrix documentation: “It is absolutely crucial to check at this stage that the resulting template mask includes all regions of the brain that are intended to be analysed. If this is not the case, the cause will be either an individual subject mask which did not include a certain region, or the template building process or individual subject registrations having gone wrong for one or more subjects. It is advised to go back to these steps, and identify and resolve the cause of the problem before continuing any further.”</span><a class="headerlink" href="#id2" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>We will then create a fixel-based mask, which should clearly show the white matter tracts of the brain:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fod2fixel</span> <span class="o">-</span><span class="n">mask</span> <span class="n">template</span><span class="o">/</span><span class="n">template_mask</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">fmls_peak_value</span> <span class="mf">0.06</span> <span class="n">template</span><span class="o">/</span><span class="n">wmfod_template</span><span class="o">.</span><span class="n">mif</span> <span class="n">template</span><span class="o">/</span><span class="n">fixel_mask</span>
</pre></div>
</div>
<p>Also make sure to visualize the output of this step by typing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mrview</span> <span class="n">template</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<figure class="align-default" id="id3">
<img alt="MRtrix/MRtrix_Course/11_Fixel_Mask.mif" src="MRtrix/MRtrix_Course/11_Fixel_Mask.mif" />
<figcaption>
<p><span class="caption-text">Fixel mask for all of the subjects. According to the MRtrix documentation: “This step ultimately determines the fixel mask in which statistical analysis will be performed, and hence also which fixels’ statistics can contribute to others via the CFE mechanism; so it may have a substantial impact on the final result. Essentially, it can be detrimental to the result if the threshold value specified via the -fmls_peak_value is too high and hence excludes genuine white matter fixels. This risk is substantially higher in voxels containing crossing fibres (and higher the more fibres are crossing in a single voxel). Even though 0.06 has been observed to be a decent default value for 3-tissue CSD population templates, it is still strongly advised to visualise the output fixel mask using mrview. Do this by opening the index.mif found in ../template/fixel_mask via the fixel plot tool. If, with respect to known or normal anatomy, fixels are missing (especially paying attention to crossing areas), regenerate the mask with a lower value supplied to the -fmls_peak_value option (of course, avoid lowering it too much, as too many false or noisy fixels may be introduced). For an adult human brain template, and using an isotropic template voxel size of 1.25 mm, it is expected to have several hundreds of thousands of fixels in the fixel mask (you can check this by mrinfo -size ../template/fixel_mask/directions.mif, and looking at the size of the image along the first dimension).” In sum, the defaults should work fine for most subjects, but you may want to change the <code class="docutils literal notranslate"><span class="pre">-fmls_peak_value</span></code> parameter if there are large gaps in the mask.</span><a class="headerlink" href="#id3" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>To make the data more normally distributed and thus make the parametric tests for valid, we will convert the data using a log transform:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="n">template</span><span class="o">/</span><span class="n">log_fc</span>
<span class="n">cp</span> <span class="n">template</span><span class="o">/</span><span class="n">fc</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">mif</span> <span class="n">template</span><span class="o">/</span><span class="n">fc</span><span class="o">/</span><span class="n">directions</span><span class="o">.</span><span class="n">mif</span> <span class="n">template</span><span class="o">/</span><span class="n">log_fc</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1">#----------------------------</span>
<span class="c1"># Slurm variables</span>

<span class="c1">#SBATCH --job-name=runDWIPreproc_changeme</span>
<span class="c1">#SBATCH --time=0:01:00</span>

<span class="c1">#SBATCH --nodes=1</span>
<span class="c1">#SBATCH --ntasks-per-node=1</span>
<span class="c1">#SBATCH --cpus-per-task=1</span>
<span class="c1">#SBATCH --mem=8gb</span>

<span class="c1">#SBATCH --account=fmrilab_project1</span>
<span class="c1">#SBATCH --partition=standard</span>

<span class="c1">#SBATCH --mail-type=NONE</span>

<span class="c1">#-----------------------------</span>
<span class="c1"># Load modules</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">mrtrix</span> <span class="n">fsl</span> <span class="n">cuda</span><span class="o">/</span><span class="mf">10.2.89</span>

<span class="c1">#-----------------------------</span>
<span class="c1"># Print diagnostic information to the job output file</span>
<span class="n">my_job_header</span>

<span class="c1">#-----------------------------</span>
<span class="c1"># Commands to run during job</span>

<span class="n">cd</span> <span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">turbo</span><span class="o">/</span><span class="n">lsa</span><span class="o">-</span><span class="n">ajahn</span><span class="o">/</span><span class="n">BTC_Preop</span><span class="o">/</span><span class="n">changeme</span>

<span class="n">mrcalc</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fc</span><span class="o">/</span><span class="n">changeme</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">log</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">log_fc</span><span class="o">/</span><span class="n">changeme</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for i in `cat subjList.txt`; do sed &quot;s|changeme|${i}|g&quot; runDWIPreproc_Phase4.sbat &gt; tmp_${i}.sbat; done
for i in `cat subjList.txt`; do sbatch tmp_${i}.sbat; done
</pre></div>
</div>
<p>To compute a measure of combined fiber density and cross-section (FDC), we will use <code class="docutils literal notranslate"><span class="pre">mrcalc</span></code> to multiple the individual fiber density and cross-section images together:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="n">template</span><span class="o">/</span><span class="n">fdc</span>
<span class="n">cp</span> <span class="n">template</span><span class="o">/</span><span class="n">fc</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">mif</span> <span class="n">template</span><span class="o">/</span><span class="n">fdc</span>
<span class="n">cp</span> <span class="n">template</span><span class="o">/</span><span class="n">fc</span><span class="o">/</span><span class="n">directions</span><span class="o">.</span><span class="n">mif</span> <span class="n">template</span><span class="o">/</span><span class="n">fdc</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1">#----------------------------</span>
<span class="c1"># Slurm variables</span>

<span class="c1">#SBATCH --job-name=runDWIPreproc_changeme</span>
<span class="c1">#SBATCH --time=0:05:00</span>

<span class="c1">#SBATCH --nodes=1</span>
<span class="c1">#SBATCH --ntasks-per-node=1</span>
<span class="c1">#SBATCH --cpus-per-task=1</span>
<span class="c1">#SBATCH --mem=8gb</span>

<span class="c1">#SBATCH --account=fmrilab_project1</span>
<span class="c1">#SBATCH --partition=standard</span>

<span class="c1">#SBATCH --mail-type=NONE</span>

<span class="c1">#-----------------------------</span>
<span class="c1"># Load modules</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">mrtrix</span> <span class="n">fsl</span> <span class="n">cuda</span><span class="o">/</span><span class="mf">10.2.89</span>

<span class="c1">#-----------------------------</span>
<span class="c1"># Print diagnostic information to the job output file</span>
<span class="n">my_job_header</span>

<span class="c1">#-----------------------------</span>
<span class="c1"># Commands to run during job</span>

<span class="n">cd</span> <span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">turbo</span><span class="o">/</span><span class="n">lsa</span><span class="o">-</span><span class="n">ajahn</span><span class="o">/</span><span class="n">BTC_Preop</span><span class="o">/</span><span class="n">changeme</span>

<span class="n">mrcalc</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fd</span><span class="o">/</span><span class="n">changeme</span><span class="o">.</span><span class="n">mif</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fc</span><span class="o">/</span><span class="n">changeme</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">mult</span> <span class="o">../</span><span class="n">template</span><span class="o">/</span><span class="n">fdc</span><span class="o">/</span><span class="n">changeme</span><span class="o">.</span><span class="n">mif</span>
</pre></div>
</div>
<p>To complete the last steps of fixel-based analysis, we will first need to create two files, <code class="docutils literal notranslate"><span class="pre">design_matrix.txt</span></code> and <code class="docutils literal notranslate"><span class="pre">contrast_matrix.txt</span></code>, which represent the subjects in each group and the contrast to be performed, respectively. In this case, we have 11 control subjects and 25 patient subjects, for a total of 36 subjects; here is the content of <code class="docutils literal notranslate"><span class="pre">design_matrix.txt</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="mi">0</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">1</span>
</pre></div>
</div>
<p>And the content of <code class="docutils literal notranslate"><span class="pre">contrast_matrix.txt</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
<p>Which will perform a contrast of the FDC images to generate an image showing where the FDC values are greater for the Control group compared to the Patient group.</p>
<p>Here is the code for the last batch job we will submit, which we will store in a script called <code class="docutils literal notranslate"><span class="pre">runDWIPreproc_Phase6.sbat</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1">#----------------------------</span>
<span class="c1"># Slurm variables</span>

<span class="c1">#SBATCH --job-name=runDWIPreproc_changeme</span>
<span class="c1">#SBATCH --time=200:00:00</span>

<span class="c1">#SBATCH --nodes=1</span>
<span class="c1">#SBATCH --ntasks-per-node=1</span>
<span class="c1">#SBATCH --cpus-per-task=1</span>
<span class="c1">#SBATCH --mem=8gb</span>

<span class="c1">#SBATCH --account=fmrilab_project1</span>
<span class="c1">#SBATCH --partition=standard</span>

<span class="c1">#SBATCH --mail-type=NONE</span>

<span class="c1">#-----------------------------</span>
<span class="c1"># Load modules</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">mrtrix</span> <span class="n">fsl</span> <span class="n">cuda</span><span class="o">/</span><span class="mf">10.2.89</span>

<span class="c1">#-----------------------------</span>
<span class="c1"># Print diagnostic information to the job output file</span>
<span class="n">my_job_header</span>

<span class="c1">#-----------------------------</span>
<span class="c1"># Commands to run during job</span>

<span class="n">cd</span> <span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">turbo</span><span class="o">/</span><span class="n">lsa</span><span class="o">-</span><span class="n">ajahn</span><span class="o">/</span><span class="n">BTC_Preop</span><span class="o">/</span><span class="n">template</span>

<span class="n">tckgen</span> <span class="o">-</span><span class="n">angle</span> <span class="mf">22.5</span> <span class="o">-</span><span class="n">maxlen</span> <span class="mi">250</span> <span class="o">-</span><span class="n">minlen</span> <span class="mi">10</span> <span class="o">-</span><span class="n">power</span> <span class="mf">1.0</span> <span class="n">wmfod_template</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">seed_image</span> <span class="n">template_mask</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">mask</span> <span class="n">template_mask</span><span class="o">.</span><span class="n">mif</span> <span class="o">-</span><span class="n">select</span> <span class="mi">20000000</span> <span class="o">-</span><span class="n">cutoff</span> <span class="mf">0.06</span> <span class="n">tracks_20_million</span><span class="o">.</span><span class="n">tck</span>
<span class="n">tcksift</span> <span class="n">tracks_20_million</span><span class="o">.</span><span class="n">tck</span> <span class="n">wmfod_template</span><span class="o">.</span><span class="n">mif</span> <span class="n">tracks_2_million_sift</span><span class="o">.</span><span class="n">tck</span> <span class="o">-</span><span class="n">term_number</span> <span class="mi">2000000</span>

<span class="n">fixelconnectivity</span> <span class="n">fixel_mask</span><span class="o">/</span> <span class="n">tracks_2_million_sift</span><span class="o">.</span><span class="n">tck</span> <span class="n">matrix</span><span class="o">/</span>

<span class="n">fixelfilter</span> <span class="n">fd</span> <span class="n">smooth</span> <span class="n">fd_smooth</span> <span class="o">-</span><span class="n">matrix</span> <span class="n">matrix</span><span class="o">/</span>
<span class="n">fixelfilter</span> <span class="n">log_fc</span> <span class="n">smooth</span> <span class="n">log_fc_smooth</span> <span class="o">-</span><span class="n">matrix</span> <span class="n">matrix</span><span class="o">/</span>
<span class="n">fixelfilter</span> <span class="n">fdc</span> <span class="n">smooth</span> <span class="n">fdc_smooth</span> <span class="o">-</span><span class="n">matrix</span> <span class="n">matrix</span><span class="o">/</span>

<span class="n">fixelcfestats</span> <span class="n">fd_smooth</span><span class="o">/</span> <span class="n">files</span><span class="o">.</span><span class="n">txt</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">txt</span> <span class="n">contrast_matrix</span><span class="o">.</span><span class="n">txt</span> <span class="n">matrix</span><span class="o">/</span> <span class="n">stats_fd</span><span class="o">/</span>
<span class="n">fixelcfestats</span> <span class="n">log_fc_smooth</span><span class="o">/</span> <span class="n">files</span><span class="o">.</span><span class="n">txt</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">txt</span> <span class="n">contrast_matrix</span><span class="o">.</span><span class="n">txt</span> <span class="n">matrix</span><span class="o">/</span> <span class="n">stats_log_fc</span><span class="o">/</span>
<span class="n">fixelcfestats</span> <span class="n">fdc_smooth</span><span class="o">/</span> <span class="n">files</span><span class="o">.</span><span class="n">txt</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">txt</span> <span class="n">contrast_matrix</span><span class="o">.</span><span class="n">txt</span> <span class="n">matrix</span><span class="o">/</span> <span class="n">stats_fdc</span><span class="o">/</span>
</pre></div>
</div>
<p>Which can be submitted by typing <code class="docutils literal notranslate"><span class="pre">sbatch</span> <span class="pre">runDWIPreproc_Phase6.sbat</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This last job may take a long time to finish, depending on how many streamlines you generate during <code class="docutils literal notranslate"><span class="pre">tckgen</span></code> and how many permutations are computed during each fo the <code class="docutils literal notranslate"><span class="pre">fixelcfestats</span></code> commands. You can decrease the amount of time by decreasing the number of streamlines, or by decreasing the number of permutations by using the <code class="docutils literal notranslate"><span class="pre">-nshuffles</span></code> option with each <code class="docutils literal notranslate"><span class="pre">fixelcfestats</span></code> command, and changing it from the default of 5000 to a lower number, such as 2000 or 3000. Changing these parameters can slightly decrease the accuracy of your final results, but for larger datasets the tradeoff might be worth it.</p>
</div>
</section>
<section id="viewing-the-results">
<h2>Viewing the Results<a class="headerlink" href="#viewing-the-results" title="Link to this heading"></a></h2>
<p>When this last phase finishes, we can visualize the results using <code class="docutils literal notranslate"><span class="pre">mrview</span></code>. As above, I recommend using the image <code class="docutils literal notranslate"><span class="pre">wmfod_template.mif</span></code> as an underlay, which you can find in the <code class="docutils literal notranslate"><span class="pre">template</span></code> directory. You can then click on <code class="docutils literal notranslate"><span class="pre">Tool</span> <span class="pre">-&gt;</span> <span class="pre">Fixel</span> <span class="pre">Plot</span></code>, and load any of the output images generated by the <code class="docutils literal notranslate"><span class="pre">fixelcfestats</span></code> comands. For example, you could load the file <code class="docutils literal notranslate"><span class="pre">fwe_1mpvalue.mif</span></code> to display which fixels are significant; in this case, since it’s a 1-p map, any fixels with a value of 0.95 or greater would pass a corrected p=0.05 threshold. The coordinates of these fixels can then be localized with your crosshairs and reported in any results tables.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="MRtrix_10_GroupAnalysis.html" class="btn btn-neutral float-left" title="MRtrix Tutorial #10: Group-Level Analysis" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../ASL/ASL_Techniques.html" class="btn btn-neutral float-right" title="fASL Tutorial #1: Background" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Andy Jahn.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>