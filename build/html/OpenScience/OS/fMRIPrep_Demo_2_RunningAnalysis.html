<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>fMRIPrep Tutorial #2: Running the Analysis &mdash; Andy&#39;s Brain Book 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b76e3c8a" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="fMRIPrep Tutorial #3: Examining the Preprocessed Data" href="fMRIPrep_Demo_3_ExaminingPreprocData.html" />
    <link rel="prev" title="fMRIPrep Tutorial #1: Downloading the Data" href="fMRIPrep_Demo_1_Download.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Andy's Brain Book
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Install</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation/fsl_mac_install.html">Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Unix for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_Intro.html">What is Unix?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_01_Navigation.html">Unix Tutorial #1: 目录操作 (Directories and Navigation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_02_CopyRemove.html">Unix Tutorial #2: Copying and Removing Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_03_ReadingTextFiles.html">Unix Tutorial #3: Reading Text Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_04_ShellsVariables.html">Unix Tutorial #4: Shells and Path Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_05_ForLoops.html">Unix Tutorial #5: For-Loops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_06_IfElse.html">Unix Tutorial #6: Conditional Statements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_07_Scripting.html">Unix Tutorial #7: Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_08_Sed.html">Unix Tutorial #8: The Sed Command</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unix/Unix_09_AutomatingTheAnalysis.html">Unix Tutorial #9: Automating The Analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">fMRI Short Course with FSL</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_Intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_01_DataDownload.html">fMRI Tutorial #1: Downloading the Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_02_ExperimentalDesign.html">fMRI Tutorial #2: Overview of The Flanker Task</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_03_LookingAtTheData.html">fMRI Tutorial #3: Looking at the Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_04_Preprocessing.html">fMRI Tutorial #4: Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_05_1stLevelAnalysis.html">fMRI Tutorial #5: Statistics and Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_06_Scripting.html">fMRI Tutorial #6: Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_07_2ndLevelAnalysis.html">fMRI Tutorial #7: 2nd-Level Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_08_3rdLevelAnalysis.html">fMRI Tutorial #8: 3rd-Level Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_09_ROIAnalysis.html">fMRI Tutorial #9: ROI Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_10_Summary.html">fMRI Tutorial #10: Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI_Short_Course/fMRI_Appendices.html">fMRI Short Course: Appendices</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FreeSurfer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FreeSurfer/FreeSurfer_Introduction.html">FreeSurfer Short Course</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">E-Prime</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../E-Prime/E-Prime_Overview.html">Overview of E-Prime</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">AFNI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../AFNI/AFNI_Overview.html">AFNI Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SPM</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../SPM/SPM_Overview.html">SPM Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Functional Connectivity with the CONN Toolbox</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FunctionalConnectivity/CONN_Overview.html">Functional Connectivity and the CONN Toolbox</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Parametric Modulation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../PM/PM_Overview.html">Parametric Modulation in SPM, FSL, and AFNI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Image Visualization with MRIcroGL</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../MRIcroGL/MRIcroGL_Overview.html">Image Visualization with MRIcroGL</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Introduction to the Human Connectome Project (HCP)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../HCP/HCP_Overview.html">Introduction to the Human Connectome Project</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Finite Impulse Response (FIR) Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FIR/FIR_Overview.html">Finite Impulse Response (FIR)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">fMRI Concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Practicals/DesignOptimization.html">Design Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Diffusion Analysis with MRtrix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../MRtrix/MRtrix_Introduction.html">Introduction to MRtrix</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ASL Analysis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/ASL_Techniques.html">fASL Tutorial #1: Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/fASL_02_Download.html">fASL Tutorial #2: Downloading and Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/fASL_03_Task.html">fASL Tutorial #3: The N-Back Task</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/04_fASL_GUI.html">fASL Tutorial #4: The GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/05_fASL_Results.html">fASL Tutorial #5: Examining the Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ASL/06_fASL_Quantification.html">fASL Tutorial #6: Quantification</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Frequently Asked Questions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../FrequentlyAskedQuestions/FrequentlyAskedQuestions.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Statistics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Statistics/GIMME.html">GIMME (Group Iterative Multiple Model Estimation)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Open Science</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../OS_Overview.html">Open Science</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="BIDS_Overview.html">BIDS Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="MRIQC.html">BIDS App Tutorial #1: MRIQC</a></li>
<li class="toctree-l2"><a class="reference internal" href="fMRIPrep.html">BIDS App Tutorial #2: fMRIPrep</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="fMRIPrep_Demo.html">fMRIPrep Demonstration</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="fMRIPrep_Demo_1_Download.html">fMRIPrep Tutorial #1: Downloading the Data</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">fMRIPrep Tutorial #2: Running the Analysis</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#background">Background</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-docker-app">The Docker App</a></li>
<li class="toctree-l4"><a class="reference internal" href="#contents-of-the-fmriprep-script">Contents of the fMRIPrep Script</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-the-script">Running the Script</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-singularity-on-a-supercomputing-cluster">Running Singularity on a Supercomputing Cluster</a></li>
<li class="toctree-l4"><a class="reference internal" href="#video">Video</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="fMRIPrep_Demo_3_ExaminingPreprocData.html">fMRIPrep Tutorial #3: Examining the Preprocessed Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="fMRIPrep_Demo_4_AdditionalPreproc.html">fMRIPrep Tutorial #4: Additional Preprocessing Steps</a></li>
<li class="toctree-l3"><a class="reference internal" href="fMRIPrep_Demo_5_1stLevelAnalysis.html">fMRIPrep Tutorial #5: Running the 1st-level Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="fMRIPrep_Demo_6_GroupAnalysis.html">fMRIPrep Tutorial #6: Group Analysis</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Github_Overview.html">Overview of Github</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Normalization Tools (ANTs)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ANTs/ANTs_Overview.html">Advanced Normalization Tools (ANTs)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tract-Based Spatial Statistics (TBSS)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../TBSS/TBSS_Overview.html">Introduction to Tract-Based Spatial Statistics (TBSS)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Statistics for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Stats/Stats_Overview.html">Statistics for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Machine Learning for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ML/ML_Overview.html">Machine Learning for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Slicer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Slicer/Slicer_Overview.html">Slicer Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CAT12</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CAT12/CAT12_Overview.html">Voxel-Based Morphometry with CAT12</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using the Supercomputer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Supercomputer/Supercomputer_Overview.html">Introduction to Supercomputing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Matlab for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Matlab/Matlab_Overview.html">Matlab for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ITK-Snap</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ITK-Snap/ITK-Snap_Overview.html">ITK-Snap_Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python for Neuroimagers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../PythonForNeuroimagers/PythonForNeuroimagers_Overview.html">Python for Neuroimagers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Meta-Analysis for fMRI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../MetaAnalysis/MetaAnalysis_Overview.html">Meta-Analysis for Neuroimagers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Andy's Brain Book</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../OS_Overview.html">Open Science</a></li>
          <li class="breadcrumb-item"><a href="fMRIPrep_Demo.html">fMRIPrep Demonstration</a></li>
      <li class="breadcrumb-item active">fMRIPrep Tutorial #2: Running the Analysis</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/OpenScience/OS/fMRIPrep_Demo_2_RunningAnalysis.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="fmriprep-tutorial-2-running-the-analysis">
<span id="fmriprep-demo-2-runninganalysis"></span><h1>fMRIPrep Tutorial #2: Running the Analysis<a class="headerlink" href="#fmriprep-tutorial-2-running-the-analysis" title="Link to this heading"></a></h1>
<hr class="docutils" />
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading"></a></h2>
<p>This chapter closely follows the steps written in <a class="reference internal" href="fMRIPrep.html#fmriprep"><span class="std std-ref">Daniel Levitas’s tutorial on fMRIPrep</span></a>, which provides the background on what fMRIPrep is and how to install it. We will be following the second option, which is to use fMRIPrep through <a class="reference external" href="https://docs.docker.com/get-docker/">Docker</a>. Once you have installed the appropriate version for your operating system, you also need to register on the FreeSurfer website <a class="reference external" href="https://surfer.nmr.mgh.harvard.edu/registration.html">here</a> and download the <code class="docutils literal notranslate"><span class="pre">license.txt</span></code> file. When it has been downloaded, move it to the <code class="docutils literal notranslate"><span class="pre">derivatives</span></code> folder of the <code class="docutils literal notranslate"><span class="pre">Flanker</span></code> directory by typing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mv</span> <span class="o">~/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">license</span><span class="o">.</span><span class="n">txt</span> <span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">Flanker</span><span class="o">/</span><span class="n">derivatives</span>
</pre></div>
</div>
<p>Once you have all of these elements, you are ready to run fMRIPrep.</p>
</section>
<section id="the-docker-app">
<h2>The Docker App<a class="headerlink" href="#the-docker-app" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Docker</span></code> App allows you to download a package of software programs that are needed to analyze a dataset. This package of programs is called a <code class="docutils literal notranslate"><span class="pre">container</span></code>. For fMRI data, for example, we can use the terminal to upgrade the docker container for fmriprep:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">user</span> <span class="o">--</span><span class="n">upgrade</span> <span class="n">fmriprep</span><span class="o">-</span><span class="n">docker</span>
</pre></div>
</div>
<p>Which will install all of the programs used by fMRIPrep - for example, tools from software packages such as FSL and ANTs to assist with normalization and denoising the data. Before executing the code that will perform fMRIPrep on the data, you need to have Docker running.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you try running the command above, you may get the following error: <code class="docutils literal notranslate"><span class="pre">ImportError:</span> <span class="pre">cannot</span> <span class="pre">import</span> <span class="pre">name</span> <span class="pre">md5</span></code>. This can happen sometimes with Python version 2.7; to fix this error, install a <a class="reference external" href="https://www.python.org/downloads/">more recent version of Python</a>, and then rerun the command:</p>
<p>python3 -m pip install –user –upgrade fmriprep-docker</p>
</div>
</section>
<section id="contents-of-the-fmriprep-script">
<h2>Contents of the fMRIPrep Script<a class="headerlink" href="#contents-of-the-fmriprep-script" title="Link to this heading"></a></h2>
<p>To run fMRIPrep, download the code from <a class="reference external" href="https://github.com/andrewjahn/OpenScience_Scripts/blob/master/fmriprep.sh">this github page</a>. Then, navigate to your <code class="docutils literal notranslate"><span class="pre">Flanker</span></code> directory and create a new sub-directory by typing <code class="docutils literal notranslate"><span class="pre">mkdir</span> <span class="pre">code</span></code>. We will place the script in this folder to keep our files organized:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mv</span> <span class="o">~/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">fmriprep</span><span class="o">.</span><span class="n">sh</span> <span class="n">code</span>
</pre></div>
</div>
<p>Let’s take a look at what the code does by typing <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">code/fmriprep_singleSubj.sh</span></code>. You should see something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#User inputs:
bids_root_dir=$HOME/Desktop/Flanker
subj=08
nthreads=4
mem=20 #gb
container=docker #docker or singularity

#Begin:

#Convert virtual memory from gb to mb
mem=`echo &quot;${mem//[!0-9]/}&quot;` #remove gb at end
mem_mb=`echo $(((mem*1000)-5000))` #reduce some memory for buffer space during pre-processing

export FS_LICENSE=$HOME/Desktop/Flanker/derivatives/license.txt

#Run fmriprep
if [ $container == singularity ]; then
  unset PYTHONPATH; singularity run -B $HOME/.cache/templateflow:/opt/templateflow $HOME/fmriprep.simg \
    $bids_root_dir $bids_root_dir/derivatives \
    participant \
    --participant-label $subj \
    --skip-bids-validation \
    --md-only-boilerplate \
    --fs-license-file $HOME/Desktop/Flanker/derivatives/license.txt \
    --fs-no-reconall \
    --output-spaces MNI152NLin2009cAsym:res-2 \
    --nthreads $nthreads \
    --stop-on-first-crash \
    --mem_mb $mem_mb \
    -w $HOME
else
  fmriprep-docker $bids_root_dir $bids_root_dir/derivatives \
    participant \
    --participant-label $subj \
    --skip-bids-validation \
    --md-only-boilerplate \
    --fs-license-file $HOME/Desktop/Flanker/derivatives/license.txt \
    --fs-no-reconall \
    --output-spaces MNI152NLin2009cAsym:res-2 \
    --nthreads $nthreads \
    --stop-on-first-crash \
    --mem_mb $mem_mb \
    -w $HOME
fi
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Thomas Ernst has made the following comment that is particularly important for Ubuntu users: “[In this script,] the temporary eval dir is set to be the $HOME dir. That is bad for two reasons: Firstly, at least on Ubunbtu, fmriprep will not clean up the temp dir, easily leading to a overfull home dir/main disk and stoping eval after a few subjects. Secondly, if you select the –clean-workdir option this will delete the entire content of the $HOME dir before crashing.”</p>
<p>Furthermore, if you are using a supercomputer cluster, you may want to use the /tmp/scratch directory to store the output. Bennet Fauber of the University of Michigan recommends setting the following variables for the directories:</p>
<p>BIDS_DIR=/tmp/workflow_${SUB}/BIDS
OUTPUT_DIR=/tmp/workflow_${SUB}/derivatives
WORK_DIR=/tmp/workflow_${SUB}/work</p>
<p>Bennet: “It’s almost certainly not a good idea to make WORK_DIR the home on a cluster, as home is likely to have a small quota, be NFS, and be slow. There’s almost always some kind of /scratch for that, or, as we do, /tmp.  If using /tmp, it’s a good idea to have code to remove work directories after the job finishes, unless debugging.</p>
</div>
<p>The first block of code, “User Inputs”, sets the path to where the data is, as well as which subject to analyze. <code class="docutils literal notranslate"><span class="pre">nthreads</span></code> specifies the number of processors to use, and <code class="docutils literal notranslate"><span class="pre">mem</span></code> specifies the amount of memory to use, in gigabytes. The variable <code class="docutils literal notranslate"><span class="pre">container</span></code> can be set to either <code class="docutils literal notranslate"><span class="pre">docker</span></code> or <code class="docutils literal notranslate"><span class="pre">singularity</span></code>; the latter, which refers to a container typically used on supercomputing clusters, will be covered in a later tutorial. For now, we will set it to <code class="docutils literal notranslate"><span class="pre">docker</span></code>. The second block of code reformats the <code class="docutils literal notranslate"><span class="pre">mem</span></code> variable to remove the suffix <code class="docutils literal notranslate"><span class="pre">gb</span></code>, so that it can be read by fMRIPrep.</p>
<p>Next we come last half of the code: an <code class="docutils literal notranslate"><span class="pre">if/else</span></code> statement that executes code depending on whether you chose <code class="docutils literal notranslate"><span class="pre">docker</span></code> or <code class="docutils literal notranslate"><span class="pre">singularity</span></code>. Since we chose <code class="docutils literal notranslate"><span class="pre">docker</span></code>, the second part of the statement will be run. Within that section, we will supply both the root directory containing the data - in other words, the <code class="docutils literal notranslate"><span class="pre">Flanker</span></code> directory - and the data where the output will be stored, which we will place in the <code class="docutils literal notranslate"><span class="pre">derivatives</span></code> subfolder.</p>
<p>The other lines in this block mostly contain options for your analysis, which we will explore later. For now, we will run a relatively simple analysis which does the standard preprocessing steps of coregistration, normalization, and physiological component extraction. The last two lines, <code class="docutils literal notranslate"><span class="pre">--mem_mb</span></code> and <code class="docutils literal notranslate"><span class="pre">-w</span></code>, use variables to specify the amount of memory to be used, and the working directory where intermediate results will be stored.</p>
</section>
<section id="running-the-script">
<h2>Running the Script<a class="headerlink" href="#running-the-script" title="Link to this heading"></a></h2>
<p>To run the script, simply navigate to the <code class="docutils literal notranslate"><span class="pre">code</span></code> directory and type the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bash</span> <span class="n">fmriprep</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>This will begin preprocessing the data for subject #8 - which, you may recall, was one of the first subjects we analyzed in the fMRI tutorials on SPM, AFNI, and FSL. Our goal here will be to compare the output from those processing pipelines with what is generated by fMRIPrep, in order to see the relative advantages and disadvantages of each.</p>
<p>Using the barebones analysis pipeline that we specified above, this should take about one or two hours to process. When it has finished, click the <code class="docutils literal notranslate"><span class="pre">Next</span></code> button.</p>
</section>
<section id="running-singularity-on-a-supercomputing-cluster">
<h2>Running Singularity on a Supercomputing Cluster<a class="headerlink" href="#running-singularity-on-a-supercomputing-cluster" title="Link to this heading"></a></h2>
<p>The following is sample code that will be updated in the future:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

#SBATCH --job-name=fmriprep
#SBATCH --nodes=1
#SBATCH --tasks-per-node=1
#SBATCH --cpus-per-task=4
#SBATCH --mem=16g
#SBATCH --mail-type=NONE
#SBATCH --partition=week-long
#SBATCH --output=/home/%u/slurm/%x-%j.log
#SBATCH --time=72:00:00

hostname -s
uptime
source /home/sw/spack/share/spack/setup-env.sh
spack load singularity

SUBJ=$1
FMRIPREP=/home/data/fmriprep-20.2.1.simg
SURF_LICENSE=/home/sw/freesurfer/license.txt

BIDS_DIR=~/Desktop/Flanker
OUTPUT_DIR=~/Desktop/Flanker/derivatives
WORK_DIR=~

singularity run \
    $FMRIPREP      \
    $BIDS_DIR $OUTPUT_DIR participant \
    --n_cpus $SLURM_CPUS_PER_TASK        \
    --omp-nthreads $SLURM_CPUS_PER_TASK \
    --fs-license-file=$SURF_LICENSE         \
    --participant-label=$SUBJ \
    --skip_bids_validation --ignore slicetiming \
    --dummy-scans 12 \
    --output-spaces anat fsnative MNI152NLin2009cAsym:res-2 fsaverage:den-10k fsLR \
    --cifti-output \
    -w $WORK_DIR
</pre></div>
</div>
</section>
<section id="video">
<h2>Video<a class="headerlink" href="#video" title="Link to this heading"></a></h2>
<p>For a video demonstration of how to set up the fmriprep.sh script, click <a class="reference external" href="https://www.youtube.com/watch?v=qCX4YlrdTAw">here</a>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="fMRIPrep_Demo_1_Download.html" class="btn btn-neutral float-left" title="fMRIPrep Tutorial #1: Downloading the Data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="fMRIPrep_Demo_3_ExaminingPreprocData.html" class="btn btn-neutral float-right" title="fMRIPrep Tutorial #3: Examining the Preprocessed Data" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Andy Jahn.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>